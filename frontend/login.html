<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ­ã‚°ã‚¤ãƒ³ - è¦³å…‰ã‚¢ãƒŠãƒ©ã‚¤ã‚¶ãƒ¼</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <div class="unified-login-container">
        <div class="login-content">
            <h1>ğŸ”ï¸ è¦³å…‰ã‚¢ãƒŠãƒ©ã‚¤ã‚¶ãƒ¼</h1>
            <p>è¦³å…‰ãƒ»ã‚°ãƒ«ãƒ¡ç”»åƒã®AIè§£æã‚µãƒ¼ãƒ“ã‚¹</p>
            
            <!-- è¨€èªé¸æŠã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <section class="language-selection-section">
                <div class="language-selector-main" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem; margin-bottom: 1.5rem; font-size: 0.85rem;">
                    <label style="display: flex; align-items: center; gap: 0.3rem;" class="lang-option">
                        <input type="radio" name="mainLang" value="ja" checked> ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.3rem;" class="lang-option">
                        <input type="radio" name="mainLang" value="ko"> ğŸ‡°ğŸ‡· í•œêµ­ì–´
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.3rem;" class="lang-option">
                        <input type="radio" name="mainLang" value="zh"> ğŸ‡¨ğŸ‡³ ç®€ä½“ä¸­æ–‡
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.3rem;" class="lang-option">
                        <input type="radio" name="mainLang" value="tw"> ğŸ‡¹ğŸ‡¼ ç¹é«”ä¸­æ–‡
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.3rem;" class="lang-option">
                        <input type="radio" name="mainLang" value="en"> ğŸŒ English
                    </label>
                </div>
            </section>
            
            <!-- Googleèªè¨¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <section class="google-auth-section">
                <div class="google-login-wrapper">
                    <p>Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†ä¸­...</p>
                    <p>ã¾ã‚‚ãªãGoogleã®ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã¸ç§»å‹•ã—ã¾ã™</p>
                </div>
            </section>
            
            <!-- åŒºåˆ‡ã‚Šç·š -->
            <div class="auth-divider">
                <span>ã¾ãŸã¯</span>
            </div>
            
            <!-- ãƒ¡ãƒ¼ãƒ«èªè¨¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <section class="email-auth-section">
                <button id="emailLoginBtn" class="email-login-btn">
                    ğŸ“§ ãƒ¡ãƒ¼ãƒ«ã§ãƒ­ã‚°ã‚¤ãƒ³
                </button>
                
                <!-- ç·Šæ€¥ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ï¼ˆç›®ç«‹ãŸãªã„ã‚ˆã†ã«é…ç½®ï¼‰ -->
                <button id="emergencyLoginBtn" class="emergency-login-btn" style="
                    width: 100%; 
                    padding: 0.6rem; 
                    margin-top: 0.5rem; 
                    background: #f0f0f0; 
                    color: #666; 
                    border: 1px solid #ddd; 
                    border-radius: 8px; 
                    font-size: 0.8rem; 
                    cursor: pointer;
                    opacity: 0.7;
                ">
                    ğŸ› ï¸ ç·Šæ€¥ãƒ­ã‚°ã‚¤ãƒ³
                </button>
            </section>
            
            <!-- ãƒ¡ãƒ¼ãƒ«èªè¨¼ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆåˆæœŸéè¡¨ç¤ºï¼‰ -->
            <div id="emailAuthForm" class="email-auth-form" style="display: none;">
                <!-- ãƒ¡ãƒ¼ãƒ«èªè¨¼UI ãŒã“ã“ã«å‹•çš„ã«æŒ¿å…¥ã•ã‚Œã‚‹ -->
            </div>
            
            <div class="back-link" style="display: none;">
                <a href="./tourism-guide.html">â† æˆ»ã‚‹</a>
            </div>
        </div>
    </div>
    
    <script>
        // API Configuration
        const API_BASE_URL = 'https://f4n095fm2j.execute-api.ap-northeast-1.amazonaws.com/dev';
        
        // Google Identity Services (GIS) implementation
        let isGoogleInitialized = false;
        
        // Page translations for main content
        const pageTranslations = {
            ja: {
                title: "ğŸ”ï¸ è¦³å…‰ã‚¢ãƒŠãƒ©ã‚¤ã‚¶ãƒ¼",
                subtitle: "è¦³å…‰ãƒ»ã‚°ãƒ«ãƒ¡ç”»åƒã®AIè§£æã‚µãƒ¼ãƒ“ã‚¹",
                googleLoginProcessing: "Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†ä¸­...",
                googleLoginRedirect: "ã¾ã‚‚ãªãGoogleã®ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã¸ç§»å‹•ã—ã¾ã™",
                googleLoginReady: "Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³",
                divider: "ã¾ãŸã¯",
                emailLoginBtn: "ğŸ“§ ãƒ¡ãƒ¼ãƒ«ã§ãƒ­ã‚°ã‚¤ãƒ³",
                emergencyLoginBtn: "ğŸ› ï¸ ç·Šæ€¥ãƒ­ã‚°ã‚¤ãƒ³",
                backLink: "â† æˆ»ã‚‹"
            },
            ko: {
                title: "ğŸ”ï¸ ê´€ê´‘ ë¶„ì„ê¸°",
                subtitle: "ê´€ê´‘ãƒ»ìŒì‹ ì´ë¯¸ì§€ì˜ AI ë¶„ì„ ì„œë¹„ìŠ¤",
                googleLoginProcessing: "Google ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸ ì²˜ë¦¬ ì¤‘...",
                googleLoginRedirect: "ê³§ Google ë¡œê·¸ì¸ í™”ë©´ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤",
                googleLoginReady: "Google ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸",
                divider: "ë˜ëŠ”",
                emailLoginBtn: "ğŸ“§ ì´ë©”ì¼ë¡œ ë¡œê·¸ì¸",
                emergencyLoginBtn: "ğŸ› ï¸ ê¸´ê¸‰ ë¡œê·¸ì¸",
                backLink: "â† ëŒì•„ê°€ê¸°"
            },
            zh: {
                title: "ğŸ”ï¸ æ—…æ¸¸åˆ†æå™¨",
                subtitle: "è§‚å…‰ãƒ»ç¾é£Ÿå›¾åƒçš„AIåˆ†ææœåŠ¡",
                googleLoginProcessing: "æ­£åœ¨ä½¿ç”¨Googleè´¦æˆ·ç™»å½•...",
                googleLoginRedirect: "å³å°†è·³è½¬åˆ°Googleç™»å½•é¡µé¢",
                googleLoginReady: "ä½¿ç”¨Googleè´¦æˆ·ç™»å½•",
                divider: "æˆ–è€…",
                emailLoginBtn: "ğŸ“§ ä½¿ç”¨é‚®ç®±ç™»å½•",
                emergencyLoginBtn: "ğŸ› ï¸ ç´§æ€¥ç™»å½•",
                backLink: "â† è¿”å›"
            },
            tw: {
                title: "ğŸ”ï¸ è§€å…‰åˆ†æå™¨",
                subtitle: "è§€å…‰ãƒ»ç¾é£Ÿåœ–åƒçš„AIåˆ†ææœå‹™",
                googleLoginProcessing: "æ­£åœ¨ä½¿ç”¨Googleå¸³æˆ¶ç™»å…¥...",
                googleLoginRedirect: "å³å°‡è·³è½‰åˆ°Googleç™»å…¥é é¢",
                googleLoginReady: "ä½¿ç”¨Googleå¸³æˆ¶ç™»å…¥",
                divider: "æˆ–è€…",
                emailLoginBtn: "ğŸ“§ ä½¿ç”¨é›»å­éƒµä»¶ç™»å…¥",
                emergencyLoginBtn: "ğŸ› ï¸ ç·Šæ€¥ç™»å…¥",
                backLink: "â† è¿”å›"
            },
            en: {
                title: "ğŸ”ï¸ Tourism Analyzer",
                subtitle: "AI Analysis Service for Tourism & Gourmet Images",
                googleLoginProcessing: "Processing Google Account Login...",
                googleLoginRedirect: "Redirecting to Google login page soon",
                googleLoginReady: "Sign in with Google Account",
                divider: "or",
                emailLoginBtn: "ğŸ“§ Sign in with Email",
                emergencyLoginBtn: "ğŸ› ï¸ Emergency Login",
                backLink: "â† Back"
            }
        };

        // Email authentication translations
        const emailAuthTranslations = {
            ja: {
                emailLogin: "ğŸ“§ ãƒ¡ãƒ¼ãƒ«ã§ãƒ­ã‚°ã‚¤ãƒ³",
                loginTitle: "è¦³å…‰ã‚¢ãƒŠãƒ©ã‚¤ã‚¶ãƒ¼ã«ãƒ­ã‚°ã‚¤ãƒ³", 
                emailPlaceholder: "ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹",
                passwordPlaceholder: "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰",
                confirmPassword: "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç¢ºèª",
                loginButton: "ãƒ­ã‚°ã‚¤ãƒ³",
                signupButton: "æ–°è¦ç™»éŒ²",
                signupLink: "æ–°è¦ç™»éŒ²",
                forgotPassword: "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¿˜ã‚ŒãŸæ–¹",
                languageSelect: "è¨€èªã‚’é¸æŠ",
                backToLogin: "æˆ»ã‚‹"
            },
            ko: {
                emailLogin: "ğŸ“§ ì´ë©”ì¼ë¡œ ë¡œê·¸ì¸",
                loginTitle: "ê´€ê´‘ ë¶„ì„ê¸°ì— ë¡œê·¸ì¸",
                emailPlaceholder: "ì´ë©”ì¼ ì£¼ì†Œ", 
                passwordPlaceholder: "ë¹„ë°€ë²ˆí˜¸",
                confirmPassword: "ë¹„ë°€ë²ˆí˜¸ í™•ì¸",
                loginButton: "ë¡œê·¸ì¸",
                signupButton: "íšŒì›ê°€ì…",
                signupLink: "íšŒì›ê°€ì…",
                forgotPassword: "ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸°",
                languageSelect: "ì–¸ì–´ ì„ íƒ",
                backToLogin: "ëŒì•„ê°€ê¸°"
            },
            zh: {
                emailLogin: "ğŸ“§ ä½¿ç”¨é‚®ç®±ç™»å½•",
                loginTitle: "ç™»å½•æ—…æ¸¸åˆ†æå™¨",
                emailPlaceholder: "é‚®ç®±åœ°å€",
                passwordPlaceholder: "å¯†ç ",
                confirmPassword: "ç¡®è®¤å¯†ç ", 
                loginButton: "ç™»å½•",
                signupButton: "æ³¨å†Œè´¦æˆ·",
                signupLink: "æ³¨å†Œè´¦æˆ·",
                forgotPassword: "å¿˜è®°å¯†ç ï¼Ÿ",
                languageSelect: "é€‰æ‹©è¯­è¨€",
                backToLogin: "è¿”å›"
            },
            tw: {
                emailLogin: "ğŸ“§ ä½¿ç”¨é›»å­éƒµä»¶ç™»å…¥",
                loginTitle: "ç™»å…¥è§€å…‰åˆ†æå™¨",
                emailPlaceholder: "é›»å­éƒµä»¶åœ°å€",
                passwordPlaceholder: "å¯†ç¢¼",
                confirmPassword: "ç¢ºèªå¯†ç¢¼",
                loginButton: "ç™»å…¥",
                signupButton: "è¨»å†Šå¸³è™Ÿ", 
                signupLink: "è¨»å†Šå¸³è™Ÿ",
                forgotPassword: "å¿˜è¨˜å¯†ç¢¼ï¼Ÿ",
                languageSelect: "é¸æ“‡èªè¨€",
                backToLogin: "è¿”å›"
            },
            en: {
                emailLogin: "ğŸ“§ Sign in with Email",
                loginTitle: "Sign in to Tourism Analyzer",
                emailPlaceholder: "Email address",
                passwordPlaceholder: "Password",
                confirmPassword: "Confirm Password",
                loginButton: "Sign in",
                signupButton: "Sign up",
                signupLink: "Sign up", 
                forgotPassword: "Forgot password?",
                languageSelect: "Select language",
                backToLogin: "Back"
            }
        };
        
        // Initialize Google Sign-In using new GIS API
        function initGoogleSignIn() {
            console.log('ğŸ”§ Initializing Google Identity Services...');
            
            try {
                // Initialize Google Identity Services
                google.accounts.id.initialize({
                    client_id: '293286695075-k6d4ojbtag15f8jl9mbd22sjbuvstm3k.apps.googleusercontent.com',
                    callback: handleCredentialResponse,
                    auto_select: false,
                    cancel_on_tap_outside: false
                });
                
                console.log('âœ… Google Identity Services initialized');
                isGoogleInitialized = true;
                showGoogleSignInButton();
                
            } catch (error) {
                console.error('âŒ Google Identity Services ã‚¨ãƒ©ãƒ¼:', error);
                showError('Googleèªè¨¼ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ãå¾Œã«å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
            }
        }
        
        // Handle credential response from Google
        function handleCredentialResponse(response) {
            console.log('ğŸ”’ Google credential received');
            
            try {
                // Extract JWT token
                const idToken = response.credential;
                console.log('âœ… Google ID Token received');
                
                // Show loading state
                showLoading();
                
                // Send to backend for processing
                exchangeGoogleTokenForCognitoToken(idToken);
                
            } catch (error) {
                console.error('âŒ Credential processing error:', error);
                showError('Googleèªè¨¼ã®å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
            }
        }
        
        function showGoogleSignInButton() {
            const wrapper = document.querySelector('.google-login-wrapper');
            wrapper.innerHTML = `
                <p>Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³</p>
                <div id="google-signin-button"></div>
                <div id="loading" style="display: none;">
                    <p>ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†ä¸­...</p>
                </div>
            `;
            
            // Render Google Sign-In button using GIS API
            if (isGoogleInitialized) {
                google.accounts.id.renderButton(
                    document.getElementById('google-signin-button'),
                    {
                        theme: 'outline',
                        size: 'large',
                        text: 'signin_with',
                        shape: 'rectangular',
                        logo_alignment: 'left'
                    }
                );
            }
        }
        
        function showLoading() {
            const wrapper = document.querySelector('.google-login-wrapper');
            wrapper.innerHTML = `
                <div id="loading">
                    <p>ğŸ”„ ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†ä¸­...</p>
                    <p>ãŠå¾…ã¡ãã ã•ã„</p>
                </div>
            `;
        }
        
        async function exchangeGoogleTokenForCognitoToken(idToken) {
            try {
                console.log('ğŸ”„ Exchanging Google token for Cognito token...');
                
                const response = await fetch('https://f4n095fm2j.execute-api.ap-northeast-1.amazonaws.com/dev/auth/google-signin', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        google_id_token: idToken
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                console.log('âœ… Token exchange successful:', result);
                
                // Cognitoãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼ã«å¯¾å¿œ
                const accessToken = result.AccessToken || result.access_token;
                const cognitoIdToken = result.IdToken || result.id_token;
                
                if (!accessToken) {
                    throw new Error('Access token not found in response');
                }
                
                // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‹ã‚‰è¿”ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’ä½¿ç”¨
                let userInfo = result.user_info || { email: '', name: '', auth_provider: 'google' };
                
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: IDTokenã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’æŠ½å‡ºï¼ˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã«user_infoãŒãªã„å ´åˆï¼‰
                if (!result.user_info && cognitoIdToken) {
                    try {
                        const payload = JSON.parse(atob(cognitoIdToken.split('.')[1]));
                        userInfo = {
                            email: payload.email || '',
                            name: payload.name || payload.given_name || '',
                            picture: payload.picture || '',
                            auth_provider: 'google'
                        };
                        console.log('ğŸ“§ Fallback: Extracted user info from ID token:', userInfo);
                    } catch (e) {
                        console.warn('âš ï¸ Could not extract user info from ID token:', e);
                    }
                } else {
                    console.log('ğŸ“§ Using user info from backend:', userInfo);
                }
                
                // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’2ç§’é–“è¡¨ç¤º
                showSuccess('èªè¨¼æˆåŠŸï¼ãƒ¡ã‚¤ãƒ³ç”»é¢ã«ç§»å‹•ã—ã¾ã™...');
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // Store authentication info in localStorage (to match tourism-guide.html)
                localStorage.setItem('tourismAuth', 'true');
                localStorage.setItem('accessToken', accessToken);
                localStorage.setItem('userInfo', JSON.stringify(userInfo));
                
                console.log('ğŸ’¾ Stored in localStorage:', {
                    tourismAuth: 'true',
                    accessToken: accessToken.substring(0, 50) + '...',
                    userInfo: userInfo
                });
                
                // Redirect to new main app (index.html)
                window.location.href = './index.html';
                
            } catch (error) {
                console.error('âŒ Token exchange failed:', error);
                showError('èªè¨¼å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
                // ã‚¨ãƒ©ãƒ¼ã‚’ç¢ºèªã™ã‚‹ãŸã‚3ç§’é–“è¡¨ç¤º
                await new Promise(resolve => setTimeout(resolve, 3000));
            }
        }
        
        function showError(message) {
            const wrapper = document.querySelector('.google-login-wrapper');
            wrapper.innerHTML = `
                <div style="color: red; margin: 20px 0;">
                    <p>âŒ ${message}</p>
                    <button onclick="location.reload()" style="margin-top: 10px; padding: 8px 16px;">
                        å†è©¦è¡Œ
                    </button>
                </div>
            `;
        }
        
        function showSuccess(message) {
            const wrapper = document.querySelector('.google-login-wrapper');
            wrapper.innerHTML = `
                <div style="color: green; margin: 20px 0; text-align: center;">
                    <p>âœ… ${message}</p>
                    <div style="margin-top: 10px;">
                        <div class="loading-spinner"></div>
                    </div>
                </div>
            `;
        }
        
        // Email Authentication Functions
        function showEmailAuthForm() {
            const currentLanguage = sessionStorage.getItem('selectedLanguage') || 'ja';
            const t = emailAuthTranslations[currentLanguage] || emailAuthTranslations['ja'];
            
            const emailAuthForm = document.getElementById('emailAuthForm');
            emailAuthForm.style.display = 'block';
            
            // Show back link when email form is displayed
            const backLink = document.querySelector('.back-link');
            if (backLink) {
                backLink.style.display = 'block';
            }
            emailAuthForm.innerHTML = `
                <h2 class="email-login-title">${t.loginTitle}</h2>
                
                <!-- è¨€èªé¸æŠ -->
                <div class="language-selector" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem; margin-bottom: 1.5rem; font-size: 0.85rem;">
                    <label style="display: flex; align-items: center; gap: 0.3rem;"><input type="radio" name="authLang" value="ja" ${currentLanguage === 'ja' ? 'checked' : ''}> ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª</label>
                    <label style="display: flex; align-items: center; gap: 0.3rem;"><input type="radio" name="authLang" value="ko" ${currentLanguage === 'ko' ? 'checked' : ''}> ğŸ‡°ğŸ‡· í•œêµ­ì–´</label>
                    <label style="display: flex; align-items: center; gap: 0.3rem;"><input type="radio" name="authLang" value="zh" ${currentLanguage === 'zh' ? 'checked' : ''}> ğŸ‡¨ğŸ‡³ ç®€ä½“ä¸­æ–‡</label>
                    <label style="display: flex; align-items: center; gap: 0.3rem;"><input type="radio" name="authLang" value="tw" ${currentLanguage === 'tw' ? 'checked' : ''}> ğŸ‡¹ğŸ‡¼ ç¹é«”ä¸­æ–‡</label>
                    <label style="display: flex; align-items: center; gap: 0.3rem;"><input type="radio" name="authLang" value="en" ${currentLanguage === 'en' ? 'checked' : ''}> ğŸŒ English</label>
                </div>
                
                <!-- ãƒ­ã‚°ã‚¤ãƒ³/ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—åˆ‡ã‚Šæ›¿ãˆ -->
                <div class="auth-mode-switcher" style="display: flex; margin-bottom: 2rem; border-radius: 25px; background: #f5f5f5; overflow: hidden;">
                    <button id="loginModeBtn" class="mode-btn active" style="flex: 1; padding: 0.8rem; border: none; background: var(--primary-color); color: white; font-weight: 600; cursor: pointer;">${t.loginButton}</button>
                    <button id="signupModeBtn" class="mode-btn" style="flex: 1; padding: 0.8rem; border: none; background: transparent; color: #666; font-weight: 600; cursor: pointer;">${t.signupButton}</button>
                </div>
                
                <!-- ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ  -->
                <form id="loginForm" style="display: block;">
                    <div class="form-group" style="text-align: left; margin-bottom: 1rem;">
                        <input type="email" id="loginEmail" placeholder="${t.emailPlaceholder}" required 
                               style="width: 100%; padding: 1rem; border: 2px solid #e1e5e9; border-radius: 12px; font-size: 1rem; box-sizing: border-box;">
                    </div>
                    <div class="form-group" style="text-align: left; margin-bottom: 1.5rem;">
                        <input type="password" id="loginPassword" placeholder="${t.passwordPlaceholder}" required
                               style="width: 100%; padding: 1rem; border: 2px solid #e1e5e9; border-radius: 12px; font-size: 1rem; box-sizing: border-box;">
                    </div>
                    <button type="submit" style="width: 100%; padding: 1rem; background: var(--primary-color); color: white; border: none; border-radius: 12px; font-size: 1.1rem; font-weight: 600; cursor: pointer; margin-bottom: 1rem;">${t.loginButton}</button>
                </form>
                
                <!-- ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ãƒ•ã‚©ãƒ¼ãƒ  -->
                <form id="signupForm" style="display: none;">
                    <div class="form-group" style="text-align: left; margin-bottom: 1rem;">
                        <input type="email" id="signupEmail" placeholder="${t.emailPlaceholder}" required
                               style="width: 100%; padding: 1rem; border: 2px solid #e1e5e9; border-radius: 12px; font-size: 1rem; box-sizing: border-box;">
                    </div>
                    <div class="form-group" style="text-align: left; margin-bottom: 1rem;">
                        <input type="password" id="signupPassword" placeholder="${t.passwordPlaceholder}" required minlength="8"
                               style="width: 100%; padding: 1rem; border: 2px solid #e1e5e9; border-radius: 12px; font-size: 1rem; box-sizing: border-box;">
                    </div>
                    <div class="form-group" style="text-align: left; margin-bottom: 1.5rem;">
                        <input type="password" id="confirmPassword" placeholder="${t.confirmPassword}" required
                               style="width: 100%; padding: 1rem; border: 2px solid #e1e5e9; border-radius: 12px; font-size: 1rem; box-sizing: border-box;">
                    </div>
                    <button type="submit" style="width: 100%; padding: 1rem; background: var(--secondary-color); color: white; border: none; border-radius: 12px; font-size: 1.1rem; font-weight: 600; cursor: pointer; margin-bottom: 1rem;">${t.signupButton}</button>
                </form>
                
                <button onclick="hideEmailAuthForm()" style="width: 100%; padding: 0.8rem; background: transparent; color: #666; border: 1px solid #ddd; border-radius: 12px; font-size: 1rem; cursor: pointer;">${t.backToLogin}</button>
            `;
            
            setupEmailAuthListeners();
        }
        
        function hideEmailAuthForm() {
            const emailAuthForm = document.getElementById('emailAuthForm');
            emailAuthForm.style.display = 'none';
            
            // Hide back link when email form is hidden
            const backLink = document.querySelector('.back-link');
            if (backLink) {
                backLink.style.display = 'none';
            }
        }
        
        function setupEmailAuthListeners() {
            // è¨€èªé¸æŠãƒªã‚¹ãƒŠãƒ¼
            document.querySelectorAll('input[name="authLang"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    sessionStorage.setItem('selectedLanguage', this.value);
                    showEmailAuthForm(); // å†æç”»
                });
            });
            
            // ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆãƒªã‚¹ãƒŠãƒ¼
            const loginModeBtn = document.getElementById('loginModeBtn');
            const signupModeBtn = document.getElementById('signupModeBtn');
            const loginForm = document.getElementById('loginForm');
            const signupForm = document.getElementById('signupForm');
            
            if (loginModeBtn && signupModeBtn && loginForm && signupForm) {
                loginModeBtn.addEventListener('click', function() {
                    loginForm.style.display = 'block';
                    signupForm.style.display = 'none';
                    this.style.background = 'var(--primary-color)';
                    this.style.color = 'white';
                    signupModeBtn.style.background = 'transparent';
                    signupModeBtn.style.color = '#666';
                });
                
                signupModeBtn.addEventListener('click', function() {
                    loginForm.style.display = 'none';
                    signupForm.style.display = 'block';
                    this.style.background = 'var(--secondary-color)';
                    this.style.color = 'white';
                    loginModeBtn.style.background = 'transparent';
                    loginModeBtn.style.color = '#666';
                });
                
                // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ãƒªã‚¹ãƒŠãƒ¼
                loginForm.addEventListener('submit', handleCognitoLogin);
                signupForm.addEventListener('submit', handleCognitoSignup);
            }
        }
        
        async function handleCognitoLogin(e) {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const submitBtn = e.target.querySelector('button[type="submit"]');
            
            if (!email || !password) {
                showMessage('ã™ã¹ã¦ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }
            
            submitBtn.disabled = true;
            submitBtn.textContent = 'èªè¨¼ä¸­...';
            
            try {
                const response = await fetch(`${API_BASE_URL}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: email,
                        password: password
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ
                    localStorage.setItem('tourismAuth', 'true');
                    localStorage.setItem('accessToken', data.tokens.AccessToken);
                    localStorage.setItem('userInfo', JSON.stringify(data.user_info));
                    
                    showMessage('ãƒ­ã‚°ã‚¤ãƒ³ã«æˆåŠŸã—ã¾ã—ãŸ', 'success');
                    setTimeout(() => {
                        window.location.href = './index.html';
                    }, 1500);
                } else {
                    throw new Error(data.error || 'ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            } catch (error) {
                console.error('Login error:', error);
                showMessage('ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'ãƒ­ã‚°ã‚¤ãƒ³';
            }
        }
        
        async function handleCognitoSignup(e) {
            e.preventDefault();
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const submitBtn = e.target.querySelector('button[type="submit"]');
            
            if (!email || !password || !confirmPassword) {
                showMessage('ã™ã¹ã¦ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }
            
            if (password !== confirmPassword) {
                showMessage('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“', 'error');
                return;
            }
            
            if (password.length < 8) {
                showMessage('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯8æ–‡å­—ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }
            
            submitBtn.disabled = true;
            submitBtn.textContent = 'ç™»éŒ²ä¸­...';
            
            try {
                const response = await fetch(`${API_BASE_URL}/auth/signup`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: email,
                        password: password,
                        display_name: email.split('@')[0]
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showMessage('ãƒ¡ãƒ¼ãƒ«ã«èªè¨¼ã‚³ãƒ¼ãƒ‰ã‚’é€ä¿¡ã—ã¾ã—ãŸ', 'success');
                } else {
                    if (data.error.includes('User already exists')) {
                        showMessage('ã“ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯æ—¢ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™', 'error');
                    } else {
                        throw new Error(data.error || 'æ–°è¦ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    }
                }
            } catch (error) {
                console.error('Signup error:', error);
                showMessage('ç™»éŒ²ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'æ–°è¦ç™»éŒ²';
            }
        }
        
        function showMessage(message, type = 'info') {
            const emailAuthForm = document.getElementById('emailAuthForm');
            let existingMessage = emailAuthForm.querySelector('.message');
            
            if (existingMessage) {
                existingMessage.remove();
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';
            messageDiv.style.cssText = `
                padding: 0.8rem;
                margin: 1rem 0;
                border-radius: 8px;
                text-align: center;
                font-weight: 500;
                ${type === 'error' ? 'background: #fee; color: #c33; border: 1px solid #fcc;' : ''}
                ${type === 'success' ? 'background: #efe; color: #383; border: 1px solid #cfc;' : ''}
                ${type === 'info' ? 'background: #eef; color: #338; border: 1px solid #ccf;' : ''}
            `;
            messageDiv.textContent = message;
            
            emailAuthForm.insertBefore(messageDiv, emailAuthForm.firstChild);
            
            // 5ç§’å¾Œã«è‡ªå‹•å‰Šé™¤
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.remove();
                }
            }, 5000);
        }
        
        // Emergency Login Functions
        function showEmergencyLogin() {
            const emailAuthForm = document.getElementById('emailAuthForm');
            emailAuthForm.style.display = 'block';
            
            // Show back link when emergency form is displayed
            const backLink = document.querySelector('.back-link');
            if (backLink) {
                backLink.style.display = 'block';
            }
            emailAuthForm.innerHTML = `
                <h2 class="emergency-login-title" style="font-size: 1.2rem; margin-bottom: 1rem; color: #666;">ğŸ› ï¸ ç·Šæ€¥ãƒ­ã‚°ã‚¤ãƒ³</h2>
                <p style="color: #666; margin-bottom: 1.5rem; font-size: 0.9rem;">é–‹ç™ºãƒ†ã‚¹ãƒˆç”¨ã®ç°¡æ˜“ãƒ­ã‚°ã‚¤ãƒ³ã§ã™</p>
                
                <form id="emergencyLoginForm">
                    <div class="form-group" style="text-align: left; margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #333; font-size: 0.9rem;">ãƒ¦ãƒ¼ã‚¶ãƒ¼ID:</label>
                        <input type="text" id="emergencyUsername" value="sapporo-guide" 
                               style="width: 100%; padding: 0.8rem; border: 2px solid #e1e5e9; border-radius: 8px; font-size: 0.9rem; box-sizing: border-box;">
                    </div>
                    <div class="form-group" style="text-align: left; margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #333; font-size: 0.9rem;">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰:</label>
                        <input type="password" id="emergencyPassword" value="hokkaido2024"
                               style="width: 100%; padding: 0.8rem; border: 2px solid #e1e5e9; border-radius: 8px; font-size: 0.9rem; box-sizing: border-box;">
                    </div>
                    <button type="submit" style="width: 100%; padding: 0.8rem; background: #ff9800; color: white; border: none; border-radius: 8px; font-size: 0.9rem; font-weight: 600; cursor: pointer; margin-bottom: 1rem;">ç·Šæ€¥ãƒ­ã‚°ã‚¤ãƒ³</button>
                </form>
                
                <button onclick="hideEmergencyLogin()" style="width: 100%; padding: 0.6rem; background: transparent; color: #666; border: 1px solid #ddd; border-radius: 8px; font-size: 0.9rem; cursor: pointer;">æˆ»ã‚‹</button>
            `;
            
            setupEmergencyLoginListeners();
        }
        
        function hideEmergencyLogin() {
            const emailAuthForm = document.getElementById('emailAuthForm');
            emailAuthForm.style.display = 'none';
            
            // Hide back link when emergency form is hidden
            const backLink = document.querySelector('.back-link');
            if (backLink) {
                backLink.style.display = 'none';
            }
        }
        
        function setupEmergencyLoginListeners() {
            const emergencyLoginForm = document.getElementById('emergencyLoginForm');
            if (emergencyLoginForm) {
                emergencyLoginForm.addEventListener('submit', handleEmergencyLogin);
            }
        }
        
        function handleEmergencyLogin(e) {
            e.preventDefault();
            const username = document.getElementById('emergencyUsername').value;
            const password = document.getElementById('emergencyPassword').value;
            const submitBtn = e.target.querySelector('button[type="submit"]');
            
            submitBtn.disabled = true;
            submitBtn.textContent = 'ãƒ­ã‚°ã‚¤ãƒ³ä¸­...';
            
            setTimeout(() => {
                if (username === 'sapporo-guide' && password === 'hokkaido2024') {
                    // æˆåŠŸæ™‚ã®ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹è¨­å®š
                    localStorage.setItem('tourismAuth', 'true');
                    localStorage.setItem('accessToken', 'emergency-login-token-dev');
                    localStorage.setItem('userInfo', JSON.stringify({
                        email: 'emergency@example.com',
                        name: 'Emergency User',
                        auth_provider: 'emergency'
                    }));
                    
                    showMessage('ç·Šæ€¥ãƒ­ã‚°ã‚¤ãƒ³ã«æˆåŠŸã—ã¾ã—ãŸ', 'success');
                    setTimeout(() => {
                        window.location.href = './index.html';
                    }, 1500);
                } else {
                    showMessage('ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“', 'error');
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'ç·Šæ€¥ãƒ­ã‚°ã‚¤ãƒ³';
                }
            }, 1000);
        }
        
        // Language switching functions
        function updatePageLanguage(language) {
            console.log('ğŸŒ Updating page language to:', language);
            
            const translations = pageTranslations[language] || pageTranslations['ja'];
            
            try {
                // Update page title and main elements
                const titleElement = document.querySelector('h1');
                if (titleElement) titleElement.textContent = translations.title;
                
                const subtitleElement = document.querySelector('.login-content > p');
                if (subtitleElement) subtitleElement.textContent = translations.subtitle;
                
                // Update divider text
                const dividerElement = document.querySelector('.auth-divider span');
                if (dividerElement) dividerElement.textContent = translations.divider;
                
                // Update button texts
                const emailLoginBtn = document.getElementById('emailLoginBtn');
                if (emailLoginBtn) emailLoginBtn.textContent = translations.emailLoginBtn;
                
                const emergencyLoginBtn = document.getElementById('emergencyLoginBtn');
                if (emergencyLoginBtn) emergencyLoginBtn.textContent = translations.emergencyLoginBtn;
                
                // Update back link
                const backLink = document.querySelector('.back-link a');
                if (backLink) backLink.textContent = translations.backLink;
                
                // Update Google login text if visible
                const googleLoginText = document.querySelector('.google-login-wrapper p');
                if (googleLoginText && !isGoogleInitialized) {
                    googleLoginText.textContent = translations.googleLoginProcessing;
                    const googleRedirectText = document.querySelector('.google-login-wrapper p:last-child');
                    if (googleRedirectText) googleRedirectText.textContent = translations.googleLoginRedirect;
                } else if (googleLoginText && isGoogleInitialized) {
                    googleLoginText.textContent = translations.googleLoginReady;
                }
                
                // Save selected language
                localStorage.setItem('selectedLanguage', language);
                sessionStorage.setItem('selectedLanguage', language);
                
                console.log('âœ… Page language updated successfully');
                
            } catch (error) {
                console.error('ğŸš¨ Error updating page language:', error);
            }
        }
        
        function setupMainLanguageSelector() {
            // Get saved language or default to Japanese
            const savedLanguage = localStorage.getItem('selectedLanguage') || 'ja';
            
            // Set the saved language as selected
            const langRadios = document.querySelectorAll('input[name="mainLang"]');
            langRadios.forEach(radio => {
                if (radio.value === savedLanguage) {
                    radio.checked = true;
                }
                
                // Add change event listener
                radio.addEventListener('change', function() {
                    if (this.checked) {
                        updatePageLanguage(this.value);
                    }
                });
            });
            
            // Apply initial language
            updatePageLanguage(savedLanguage);
        }
        
        // Load Google Identity Services and initialize
        window.addEventListener('load', function() {
            console.log('ğŸ“„ login.html loaded, initializing Google Identity Services...');
            
            // Setup main language selector first
            setupMainLanguageSelector();
            
            // Load Google Identity Services script
            const script = document.createElement('script');
            script.src = 'https://accounts.google.com/gsi/client';
            script.onload = function() {
                console.log('ğŸ“¥ Google Identity Services script loaded');
                // Add small delay to ensure Google object is ready
                setTimeout(initGoogleSignIn, 100);
            };
            script.onerror = function() {
                console.error('âŒ Google Identity Services script load failed');
                showError('Googleèªè¨¼ã‚µãƒ¼ãƒ“ã‚¹ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
            };
            document.head.appendChild(script);
            
            // Setup Email Login Button Event Listener
            const emailLoginBtn = document.getElementById('emailLoginBtn');
            if (emailLoginBtn) {
                emailLoginBtn.addEventListener('click', function() {
                    console.log('ğŸ“§ Email login button clicked');
                    showEmailAuthForm();
                });
            }
            
            // Setup Emergency Login Button Event Listener
            const emergencyLoginBtn = document.getElementById('emergencyLoginBtn');
            if (emergencyLoginBtn) {
                emergencyLoginBtn.addEventListener('click', function() {
                    console.log('ğŸ› ï¸ Emergency login button clicked');
                    showEmergencyLogin();
                });
            }
        });
    </script>
</body>
</html>