<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>è¦³å…‰ã‚¢ãƒŠãƒ©ã‚¤ã‚¶ãƒ¼</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ”ï¸</text></svg>">
    <!-- Google Fonts for enhanced UI -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/styles.css?v=20250814020000">
    
    <!-- Markdown parsing and security libraries -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify/dist/purify.min.js"></script>
    
    <!-- Stripe.js SDK -->
    <script src="https://js.stripe.com/v3/"></script>
</head>
<body>
    <div class="app">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div class="logo">
                    ğŸ”ï¸ <span data-i18n="title">è¦³å…‰ã‚¢ãƒŠãƒ©ã‚¤ã‚¶ãƒ¼</span>
                    <span class="version-tag">ver1.2</span>
                </div>
                <div class="user-section">
                    <div id="userInfo" class="user-info">
                        <span>ğŸ‘¤ <span id="currentUser">tourist-guide</span></span>
                        <span id="userPlan" class="user-plan">Free (æ®‹ã‚Š5å›)</span>
                        <button id="upgradeBtn" onclick="showUpgradeModal()" class="upgrade-btn" style="display: none;">â­ ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰</button>
                        <button onclick="logout()" class="logout-btn" data-i18n="logout">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
                    </div>
                </div>
            </div>
        </header>

        <div class="container">
            <!-- Login Section -->
            <div id="loginSection" class="login-section">
                <div class="login-card fade-in">
                    <h1 class="login-title">ğŸ”ï¸</h1>
                    <h2 class="login-subtitle" data-i18n="loginTitle">è¦³å…‰ã‚¢ãƒŠãƒ©ã‚¤ã‚¶ãƒ¼</h2>
                    
                    <!-- Googleãƒ­ã‚°ã‚¤ãƒ³ -->
                    <button id="googleLoginBtn" class="google-login-btn">
                        <svg width="18" height="18" viewBox="0 0 24 24">
                            <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                            <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                            <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                            <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                        </svg>
                        <span data-i18n="googleLogin">Googleã§ãƒ­ã‚°ã‚¤ãƒ³</span>
                    </button>
                    
                    <!-- ãƒ¡ãƒ¼ãƒ«ãƒ­ã‚°ã‚¤ãƒ³ -->
                    <div class="divider">
                        <span data-i18n="orDivider">ã¾ãŸã¯</span>
                    </div>
                    
                    <button id="emailLoginBtn" class="email-login-btn" data-i18n="emailLogin">
                        ğŸ“§ ãƒ¡ãƒ¼ãƒ«ã§ãƒ­ã‚°ã‚¤ãƒ³
                    </button>
                    
                    <div class="features-info">
                        <p><strong>ğŸ† æ–°æ©Ÿèƒ½</strong></p>
                        <p>â€¢ ç„¡æ–™: æœˆ5å›ã¾ã§è§£æ</p>
                        <p>â€¢ ãƒ—ãƒ¬ãƒŸã‚¢ãƒ : ç„¡åˆ¶é™åˆ©ç”¨</p>
                        <p>â€¢ 5è¨€èªå¯¾å¿œ: ğŸ‡¯ğŸ‡µ/ğŸ‡°ğŸ‡·/ğŸ‡¨ğŸ‡³/ğŸ‡¹ğŸ‡¼/ğŸŒ</p>
                        <p><small>åº—èˆ—ãƒ»è¦³å…‰åœ°ãƒ»æ–™ç†ç”»åƒã‚’AIãŒè©³ã—ãè§£æ</small></p>
                    </div>
                </div>
            </div>

            <!-- Main Application -->
            <div id="mainApp" class="main-app">
                <!-- Welcome Section -->
                <section class="welcome-section fade-in">
                    <h1 class="welcome-title" data-i18n="title">è¦³å…‰AIç”»åƒè§£æ</h1>
                    <p class="welcome-description">
                        <span data-i18n="description">åº—èˆ—ãƒ»è¦³å…‰åœ°ãƒ»æ–™ç†ã®ç”»åƒã‚’AIãŒè©³ã—ãè§£æã—ã€åœ°å…ƒæƒ…å ±ã‚„ãŠã™ã™ã‚ã‚¹ãƒãƒƒãƒˆã‚’ã”ç´¹ä»‹ã—ã¾ã™</span>
                    </p>
                </section>

                <!-- Language Selection -->
                <section class="language-section">
                    <h3 class="language-title" data-i18n="languageSelect">ğŸŒ è§£æè¨€èªã‚’é¸æŠ</h3>
                    <div class="language-options">
                        <label class="language-option">
                            <input type="radio" name="language" value="ja" checked>
                            <span class="language-name">ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª</span>
                        </label>
                        <label class="language-option">
                            <input type="radio" name="language" value="ko">
                            <span class="language-name">ğŸ‡°ğŸ‡· í•œêµ­ì–´</span>
                        </label>
                        <label class="language-option">
                            <input type="radio" name="language" value="zh">
                            <span class="language-name">ğŸ‡¨ğŸ‡³ ç®€ä½“ä¸­æ–‡</span>
                        </label>
                        <label class="language-option">
                            <input type="radio" name="language" value="zh-tw">
                            <span class="language-name">ğŸ‡¹ğŸ‡¼ ç¹é«”ä¸­æ–‡</span>
                        </label>
                        <label class="language-option">
                            <input type="radio" name="language" value="en">
                            <span class="language-name">ğŸŒ English</span>
                        </label>
                    </div>
                </section>

                <!-- Analysis Type Selection -->
                <section class="analysis-type-section">
                    <h3 class="analysis-title" data-i18n="analysisTypeSelect">ğŸ” è§£æã‚¿ã‚¤ãƒ—ã‚’é¸æŠ</h3>
                    <div class="analysis-options">
                        <label class="analysis-option store-option">
                            <input type="radio" name="analysisType" value="store" checked>
                            <span class="analysis-icon">ğŸªğŸ•Œ</span>
                            <span class="analysis-name" data-i18n="storeAnalysis">åº—èˆ—ãƒ»è¦³å…‰åœ°åˆ†æ</span>
                        </label>
                        <label class="analysis-option menu-option">
                            <input type="radio" name="analysisType" value="menu">
                            <span class="analysis-icon">ğŸ“‹ğŸœ</span>
                            <span class="analysis-name" data-i18n="menuTranslation">çœ‹æ¿ãƒ»ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç¿»è¨³</span>
                        </label>
                    </div>
                </section>

                <!-- Upload Section -->
                <section id="uploadSection" class="upload-section" onclick="document.getElementById('imageInput').click()">
                    <div class="upload-icon">ğŸ“¸</div>
                    <div class="upload-text" data-i18n="uploadText">ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</div>
                    <div class="upload-subtext">
                        <span data-i18n="uploadSubtext">åº—èˆ—ãƒ»è¦³å…‰åœ°ãƒ»æ–™ç†ã®å†™çœŸã‚’ã‚¯ãƒªãƒƒã‚¯ã¾ãŸã¯ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—</span><br>
                        <strong><span data-i18n="fileFormat">å¯¾å¿œå½¢å¼: JPG, PNG, GIF (æœ€å¤§ 10MB)</span></strong><br>
                        <strong><span id="recommendedText" data-i18n="storeRecommended">æ¨å¥¨: åç‰©æ–™ç†ã€è¦³å…‰åæ‰€ã€ã‚¤ãƒ™ãƒ³ãƒˆç­‰</span></strong>
                    </div>
                    <input type="file" id="imageInput" class="file-input" accept="image/*">
                </section>

                <!-- Preview Section -->
                <section id="previewSection" class="preview-section hidden">
                    <h3 class="preview-title" data-i18n="previewTitle">ğŸ“‹ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h3>
                    <img id="previewImage" class="preview-image" alt="ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼">
                    <div id="imageDetails" class="image-details"></div>
                    <button onclick="analyzeImage()" id="analyzeBtn" class="analyze-btn">
                        <span id="analyzeBtnText" data-i18n="analyzeButton">ğŸ¤– è¦³å…‰AIè§£æã‚’é–‹å§‹</span>
                    </button>
                </section>

                <!-- Loading Section -->
                <section id="loadingSection" class="loading-section hidden">
                    <div class="simple-loading-spinner"></div>
                    <div class="loading-text" data-i18n="loading">è¦³å…‰AIãŒè§£æä¸­...</div>
                    <div class="loading-subtext">
                        <span data-i18n="loadingSubtext">åç‰©æ–™ç†ãƒ»è¦³å…‰åæ‰€ãƒ»åœ°å…ƒæƒ…å ±</span><br>
                        <span data-i18n="loadingDetail">è©³ç´°ãªåœ°å…ƒæƒ…å ±ã‚’åˆ†æã—ã¦ã„ã¾ã™</span>
                    </div>
                </section>

                <!-- Results Section -->
                <section id="resultsSection" class="results-section hidden">
                    <div class="results-header">
                        <h3 class="results-title">ğŸ”ï¸ è¦³å…‰AIè§£æçµæœ</h3>
                        <button onclick="newAnalysis()" class="new-analysis-btn" data-i18n="newAnalysis">ğŸ”„ æ–°ã—ã„è§£æ</button>
                    </div>
                    <div id="resultsContent" class="results-content"></div>
                </section>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE_URL = 'https://f4n095fm2j.execute-api.ap-northeast-1.amazonaws.com/dev';
        const CREDENTIALS = {
            username: 'tourist-guide',
            password: 'hokkaido2024'
        };

        // State
        let selectedImage = null;
        let isLoggedIn = false;
        
        // Message display function - defined early to be available everywhere
        function showMessage(message, type = 'info') {
            console.log(`${type.toUpperCase()}: ${message}`);
            
            // Create or update message element
            let messageEl = document.getElementById('message-display');
            if (!messageEl) {
                messageEl = document.createElement('div');
                messageEl.id = 'message-display';
                messageEl.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    padding: 12px 20px;
                    border-radius: 8px;
                    z-index: 10000;
                    max-width: 400px;
                    font-weight: 500;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                `;
                document.body.appendChild(messageEl);
            }
            
            // Set style based on type
            const styles = {
                success: 'background: #d1edda; color: #155724; border-left: 4px solid #28a745;',
                error: 'background: #f8d7da; color: #721c24; border-left: 4px solid #dc3545;',
                info: 'background: #d1ecf1; color: #0c5460; border-left: 4px solid #17a2b8;'
            };
            
            messageEl.style.cssText += styles[type] || styles.info;
            messageEl.textContent = message;
            messageEl.style.display = 'block';
            
            // Auto hide after 5 seconds
            setTimeout(() => {
                if (messageEl) {
                    messageEl.style.display = 'none';
                }
            }, 5000);
        }

        // Translation dictionary for UI internationalization
        const translations = {
            ja: {
                title: "è¦³å…‰ã‚¢ãƒŠãƒ©ã‚¤ã‚¶ãƒ¼",
                description: "è¦³å…‰ãƒ»ã‚°ãƒ«ãƒ¡ç”»åƒã‚’AIè§£æã—ã€åœ°å…ƒæƒ…å ±ã‚’ã”ç´¹ä»‹",
                languageSelect: "è§£æè¨€èªã‚’é¸æŠ",
                analysisTypeSelect: "è§£æã‚¿ã‚¤ãƒ—ã‚’é¸æŠ",
                storeAnalysis: "åº—èˆ—ãƒ»è¦³å…‰åœ°åˆ†æ",
                menuTranslation: "çœ‹æ¿ãƒ»ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç¿»è¨³",
                uploadText: "ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰",
                uploadSubtext: "åº—èˆ—ãƒ»è¦³å…‰åœ°ãƒ»æ–™ç†ã®å†™çœŸã‚’ã‚¯ãƒªãƒƒã‚¯ã¾ãŸã¯ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—",
                fileFormat: "å¯¾å¿œå½¢å¼: JPG, PNG, GIF (æœ€å¤§ 10MB)",
                storeRecommended: "æ¨å¥¨: åç‰©æ–™ç†ã€è¦³å…‰åæ‰€ã€ã‚¤ãƒ™ãƒ³ãƒˆç­‰",
                menuRecommended: "ç‰¹ã«æœ‰åŠ¹: æ‰‹æ›¸ããƒ¡ãƒ‹ãƒ¥ãƒ¼ã€ä¾¡æ ¼è¡¨ã€æ³¨æ–‡è¡¨ç­‰",
                previewTitle: "ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼",
                analyzeButton: "è¦³å…‰AIè§£æã‚’é–‹å§‹",
                loading: "è¦³å…‰AIãŒè§£æä¸­...",
                loadingSubtext: "åç‰©æ–™ç†ãƒ»è¦³å…‰åæ‰€ãƒ»åœ°å…ƒæƒ…å ±",
                loadingDetail: "è©³ç´°ãªåœ°å…ƒæƒ…å ±ã‚’åˆ†æã—ã¦ã„ã¾ã™",
                loginTitle: "è¦³å…‰ã‚¢ãƒŠãƒ©ã‚¤ã‚¶ãƒ¼",
                googleLogin: "Googleã§ãƒ­ã‚°ã‚¤ãƒ³",
                googleRedirecting: "Googleã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆä¸­...",
                emailLogin: "ãƒ¡ãƒ¼ãƒ«ã§ãƒ­ã‚°ã‚¤ãƒ³",
                orDivider: "ã¾ãŸã¯",
                loginProcessing: "èªè¨¼ä¸­...",
                signupPrompt: "ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ãŠæŒã¡ã§ãªã„æ–¹ã¯",
                signupLink: "æ–°è¦ç™»éŒ²",
                forgotPassword: "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¿˜ã‚ŒãŸæ–¹",
                confirmPassword: "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç¢ºèª",
                signup: "æ–°è¦ç™»éŒ²",
                backToLogin: "ãƒ­ã‚°ã‚¤ãƒ³ã«æˆ»ã‚‹",
                googleLoginNotReady: "Googleãƒ­ã‚°ã‚¤ãƒ³ã¯ç¾åœ¨è¨­å®šä¸­ã§ã™ã€‚ãƒ¡ãƒ¼ãƒ«ãƒ­ã‚°ã‚¤ãƒ³ã‚’ã”åˆ©ç”¨ãã ã•ã„ã€‚",
                currentUser: "ãƒ¦ãƒ¼ã‚¶ãƒ¼",
                logout: "ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ",
                newAnalysis: "æ–°ã—ã„è§£æ",
                startText: "é–‹å§‹",
                // Premium Modal
                upgradeTitle: "â­ ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ—ãƒ©ãƒ³ã«ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰",
                upgradeDescription: "ç„¡åˆ¶é™ã§AIè§£æã‚’ãŠæ¥½ã—ã¿ãã ã•ã„",
                plan7days: "7æ—¥é–“ãƒ—ãƒ©ãƒ³",
                plan20days: "20æ—¥é–“ãƒ—ãƒ©ãƒ³",
                price980: "Â¥980",
                price1980: "Â¥1,980",
                duration7days: "1é€±é–“ç„¡åˆ¶é™",
                duration20days: "20æ—¥é–“ç„¡åˆ¶é™",
                featureUnlimited: "AIè§£æç„¡åˆ¶é™",
                featurePriority: "é«˜å„ªå…ˆåº¦å‡¦ç†",
                featureReport: "è©³ç´°åˆ†æãƒ¬ãƒãƒ¼ãƒˆ",
                proceedPayment: "æ±ºæ¸ˆã«é€²ã‚€",
                cancelPayment: "ã‚­ãƒ£ãƒ³ã‚»ãƒ«",
                popularPlan: "äººæ°—ãƒ—ãƒ©ãƒ³",
                paymentPreparation: "ğŸ’³ æ±ºæ¸ˆãƒšãƒ¼ã‚¸ã«ç§»å‹•ä¸­...",
                stripeRedirect: "å®‰å…¨ãªStripeæ±ºæ¸ˆãƒšãƒ¼ã‚¸ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã—ã¦ã„ã¾ã™...",
                paymentSecurity: "ğŸ”’ SSLæš—å·åŒ–é€šä¿¡ãƒ»Stripeç¤¾ã«ã‚ˆã‚‹å®‰å…¨æ±ºæ¸ˆ"
            },
            ko: {
                title: "ê´€ê´‘ ì• ë„ë¼ì´ì €",
                description: "ê´€ê´‘ãƒ»ë¯¸ì‹ ì´ë¯¸ì§€ AI ë¶„ì„ìœ¼ë¡œ í˜„ì§€ ì •ë³´ ì œê³µ",
                languageSelect: "ë¶„ì„ ì–¸ì–´ ì„ íƒ",
                analysisTypeSelect: "ë¶„ì„ ìœ í˜• ì„ íƒ", 
                storeAnalysis: "ìƒì ãƒ»ê´€ê´‘ì§€ ë¶„ì„",
                menuTranslation: "ê°„íŒãƒ»ë©”ë‰´ ë²ˆì—­",
                uploadText: "ì´ë¯¸ì§€ ì—…ë¡œë“œ",
                uploadSubtext: "ìƒì ãƒ»ê´€ê´‘ì§€ãƒ»ìš”ë¦¬ ì‚¬ì§„ì„ í´ë¦­í•˜ê±°ë‚˜ ë“œë˜ê·¸ & ë“œë¡­",
                fileFormat: "ëŒ€ì‘ í˜•ì‹: JPG, PNG, GIF (ìµœëŒ€ 10MB)",
                storeRecommended: "ì¶”ì²œ: ëª…ë¬¼ìš”ë¦¬, ê´€ê´‘ëª…ì†Œ, ì´ë²¤íŠ¸ ë“±",
                menuRecommended: "íŠ¹íˆ íš¨ê³¼ì : ì†ê¸€ì”¨ ë©”ë‰´, ê°€ê²©í‘œ, ì£¼ë¬¸í‘œ ë“±",
                previewTitle: "ì—…ë¡œë“œ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°",
                analyzeButton: "ê´€ê´‘ AI ë¶„ì„ ì‹œì‘",
                loading: "ê´€ê´‘ AIê°€ ë¶„ì„ì¤‘...",
                loadingSubtext: "ëª…ë¬¼ìš”ë¦¬ãƒ»ê´€ê´‘ëª…ì†Œãƒ»ì§€ì—­ ì •ë³´",
                loadingDetail: "ìƒì„¸í•œ ì§€ì—­ ì •ë³´ë¥¼ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤",
                loginTitle: "ê´€ê´‘ ì• ë„ë¼ì´ì €",
                loginUsername: "ì‚¬ìš©ì ID",
                loginPassword: "ë¹„ë°€ë²ˆí˜¸",
                loginButton: "ë¡œê·¸ì¸",
                googleLogin: "Googleë¡œ ë¡œê·¸ì¸",
                googleRedirecting: "Googleë¡œ ë¦¬ë””ë ‰íŠ¸ ì¤‘...",
                emailLogin: "ì´ë©”ì¼ë¡œ ë¡œê·¸ì¸", 
                orDivider: "ë˜ëŠ”",
                loginProcessing: "ì¸ì¦ì¤‘...",
                signupPrompt: "ê³„ì •ì´ ì—†ìœ¼ì‹ ê°€ìš”?",
                signupLink: "íšŒì›ê°€ì…",
                forgotPassword: "ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸°",
                confirmPassword: "ë¹„ë°€ë²ˆí˜¸ í™•ì¸",
                signup: "íšŒì›ê°€ì…",
                backToLogin: "ë¡œê·¸ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°",
                googleLoginNotReady: "Google ë¡œê·¸ì¸ì€ í˜„ì¬ ì„¤ì • ì¤‘ì…ë‹ˆë‹¤. ì´ë©”ì¼ ë¡œê·¸ì¸ì„ ì´ìš©í•´ ì£¼ì„¸ìš”.",
                currentUser: "ãƒ¦ãƒ¼ã‚¶ãƒ¼",
                logout: "ë¡œê·¸ì•„ì›ƒ",
                newAnalysis: "ìƒˆë¡œìš´ ë¶„ì„",
                startText: "ì‹œì‘",
                // Premium Modal
                upgradeTitle: "â­ í”„ë¦¬ë¯¸ì—„ í”Œëœìœ¼ë¡œ ì—…ê·¸ë ˆì´ë“œ",
                upgradeDescription: "ë¬´ì œí•œ AI ë¶„ì„ì„ ì´ìš©í•˜ì„¸ìš”",
                plan7days: "7ì¼ê°„ í”Œëœ",
                plan20days: "20ì¼ê°„ í”Œëœ",
                price980: "Â¥980",
                price1980: "Â¥1,980",
                duration7days: "1ì£¼ì¼ ë¬´ì œí•œ",
                duration20days: "20ì¼ê°„ ë¬´ì œí•œ",
                featureUnlimited: "AIë¶„ì„ ë¬´ì œí•œ",
                featurePriority: "ë†’ì€ ìš°ì„ ìˆœìœ„ ì²˜ë¦¬",
                featureReport: "ìƒì„¸ ë¶„ì„ ë³´ê³ ì„œ",
                proceedPayment: "ê²°ì œ ì§„í–‰",
                cancelPayment: "ì·¨ì†Œ",
                popularPlan: "ì¸ê¸° í”Œëœ",
                paymentPreparation: "ğŸ’³ ê²°ì œ í˜ì´ì§€ë¡œ ì´ë™ ì¤‘...",
                stripeRedirect: "ì•ˆì „í•œ Stripe ê²°ì œ í˜ì´ì§€ë¡œ ë¦¬ë””ë ‰íŠ¸ ì¤‘ì…ë‹ˆë‹¤...",
                paymentSecurity: "ğŸ”’ SSL ì•”í˜¸í™” í†µì‹ ãƒ»Stripeì‚¬ ì•ˆì „ ê²°ì œ"
            },
            zh: {
                title: "è§‚å…‰åˆ†æå™¨",
                description: "AIåˆ†æè§‚å…‰ãƒ»ç¾é£Ÿå›¾åƒï¼Œæä¾›å½“åœ°ä¿¡æ¯",
                languageSelect: "é€‰æ‹©åˆ†æè¯­è¨€",
                analysisTypeSelect: "é€‰æ‹©åˆ†æç±»å‹",
                storeAnalysis: "åº—é“ºãƒ»è§‚å…‰åœ°åˆ†æ",
                menuTranslation: "æ‹›ç‰Œãƒ»èœå•ç¿»è¯‘",
                uploadText: "ä¸Šä¼ å›¾åƒ",
                uploadSubtext: "ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ åº—é“ºãƒ»è§‚å…‰åœ°ãƒ»æ–™ç†ç…§ç‰‡",
                fileFormat: "æ”¯æŒæ ¼å¼: JPG, PNG, GIF (æœ€å¤§ 10MB)",
                storeRecommended: "æ¨è: åç‰©æ–™ç†ã€è§‚å…‰åèƒœã€æ´»åŠ¨ç­‰",
                menuRecommended: "ç‰¹åˆ«æœ‰æ•ˆ: æ‰‹å†™èœå•ã€ä»·æ ¼è¡¨ã€è®¢å•ç­‰",
                previewTitle: "ä¸Šä¼ å›¾åƒé¢„è§ˆ",
                analyzeButton: "å¼€å§‹è§‚å…‰AIåˆ†æ",
                loading: "è§‚å…‰AIåˆ†æä¸­...",
                loadingSubtext: "åç‰©æ–™ç†ãƒ»è§‚å…‰åèƒœãƒ»åœ°æ–¹ä¿¡æ¯",
                loadingDetail: "æ­£åœ¨åˆ†æè¯¦ç»†çš„å½“åœ°ä¿¡æ¯",
                loginTitle: "è§‚å…‰åˆ†æå™¨",
                loginUsername: "ç”¨æˆ·ID",
                loginPassword: "å¯†ç ",
                loginButton: "ç™»å½•",
                googleLogin: "Googleç™»å½•",
                googleRedirecting: "æ­£åœ¨è·³è½¬åˆ°Google...",
                emailLogin: "é‚®ç®±ç™»å½•",
                orDivider: "æˆ–è€…",
                loginProcessing: "è®¤è¯ä¸­...",
                signupPrompt: "è¿˜æ²¡æœ‰è´¦æˆ·ï¼Ÿ",
                signupLink: "æ³¨å†Œè´¦æˆ·",
                forgotPassword: "å¿˜è®°å¯†ç ï¼Ÿ",
                confirmPassword: "ç¡®è®¤å¯†ç ",
                signup: "æ³¨å†Œ",
                backToLogin: "è¿”å›ç™»å½•",
                googleLoginNotReady: "Googleç™»å½•ç›®å‰æ­£åœ¨è®¾ç½®ä¸­ã€‚è¯·ä½¿ç”¨é‚®ç®±ç™»å½•ã€‚",
                currentUser: "ãƒ¦ãƒ¼ã‚¶ãƒ¼",
                logout: "é€€å‡ºç™»å½•",
                newAnalysis: "æ–°çš„åˆ†æ",
                startText: "å¼€å§‹",
                // Premium Modal
                upgradeTitle: "â­ å‡çº§åˆ°é«˜çº§æ–¹æ¡ˆ",
                upgradeDescription: "æ— é™åˆ¶ä½¿ç”¨AIåˆ†æåŠŸèƒ½",
                plan7days: "7å¤©æ–¹æ¡ˆ",
                plan20days: "20å¤©æ–¹æ¡ˆ",
                price980: "Â¥980",
                price1980: "Â¥1,980",
                duration7days: "1å‘¨æ— é™åˆ¶",
                duration20days: "20å¤©æ— é™åˆ¶",
                featureUnlimited: "AIåˆ†ææ— é™åˆ¶",
                featurePriority: "é«˜ä¼˜å…ˆçº§å¤„ç†",
                featureReport: "è¯¦ç»†åˆ†ææŠ¥å‘Š",
                proceedPayment: "è¿›è¡Œæ”¯ä»˜",
                cancelPayment: "å–æ¶ˆ",
                popularPlan: "çƒ­é—¨æ–¹æ¡ˆ",
                paymentPreparation: "ğŸ’³ æ­£åœ¨è·³è½¬åˆ°æ”¯ä»˜é¡µé¢...",
                stripeRedirect: "æ­£åœ¨è·³è½¬åˆ°å®‰å…¨çš„Stripeæ”¯ä»˜é¡µé¢...",
                paymentSecurity: "ğŸ”’ SSLåŠ å¯†é€šä¿¡ãƒ»Stripeå®‰å…¨æ”¯ä»˜"
            },
            'zh-tw': {
                title: "è§€å…‰åˆ†æå™¨",
                description: "AIåˆ†æè§€å…‰ãƒ»ç¾é£Ÿåœ–åƒï¼Œæä¾›ç•¶åœ°è³‡è¨Š",
                languageSelect: "é¸æ“‡åˆ†æèªè¨€",
                analysisTypeSelect: "é¸æ“‡åˆ†æé¡å‹",
                storeAnalysis: "åº—é‹ªãƒ»è§€å…‰åœ°åˆ†æ",
                menuTranslation: "æ‹›ç‰Œãƒ»èœå–®ç¿»è­¯",
                uploadText: "ä¸Šå‚³åœ–åƒ",
                uploadSubtext: "é»æ“Šæˆ–æ‹–æ‹½ä¸Šå‚³åº—é‹ªãƒ»è§€å…‰åœ°ãƒ»æ–™ç†ç…§ç‰‡",
                fileFormat: "æ”¯æ´æ ¼å¼: JPG, PNG, GIF (æœ€å¤§ 10MB)",
                storeRecommended: "æ¨è–¦: åç‰©æ–™ç†ã€è§€å…‰åå‹ã€æ´»å‹•ç­‰",
                menuRecommended: "ç‰¹åˆ¥æœ‰æ•ˆ: æ‰‹å¯«èœå–®ã€åƒ¹æ ¼è¡¨ã€è¨‚å–®ç­‰",
                previewTitle: "ä¸Šå‚³åœ–åƒé è¦½",
                analyzeButton: "é–‹å§‹è§€å…‰AIåˆ†æ",
                loading: "è§€å…‰AIåˆ†æä¸­...",
                loadingSubtext: "åç‰©æ–™ç†ãƒ»è§€å…‰åå‹ãƒ»åœ°æ–¹è³‡è¨Š",
                loadingDetail: "æ­£åœ¨åˆ†æè©³ç´°çš„ç•¶åœ°è³‡è¨Š",
                loginTitle: "è§€å…‰åˆ†æå™¨",
                loginUsername: "ä½¿ç”¨è€…ID",
                loginPassword: "å¯†ç¢¼",
                loginButton: "ç™»å…¥",
                googleLogin: "Googleç™»å…¥",
                googleRedirecting: "æ­£åœ¨è½‰è‡³Google...",
                emailLogin: "é›»å­éƒµä»¶ç™»å…¥",
                orDivider: "æˆ–",
                loginProcessing: "èªè­‰ä¸­...",
                signupPrompt: "é‚„æ²’æœ‰å¸³è™Ÿï¼Ÿ",
                signupLink: "è¨»å†Šå¸³è™Ÿ",
                forgotPassword: "å¿˜è¨˜å¯†ç¢¼ï¼Ÿ",
                confirmPassword: "ç¢ºèªå¯†ç¢¼",
                signup: "è¨»å†Š",
                backToLogin: "è¿”å›ç™»å…¥",
                googleLoginNotReady: "Googleç™»å…¥ç›®å‰æ­£åœ¨è¨­ç½®ä¸­ã€‚è«‹ä½¿ç”¨é›»å­éƒµä»¶ç™»å…¥ã€‚",
                currentUser: "ãƒ¦ãƒ¼ã‚¶ãƒ¼",
                logout: "ç™»å‡º",
                newAnalysis: "æ–°çš„åˆ†æ",
                startText: "é–‹å§‹",
                // Premium Modal
                upgradeTitle: "â­ å‡ç´šè‡³é€²éšæ–¹æ¡ˆ",
                upgradeDescription: "ç„¡é™åˆ¶ä½¿ç”¨AIåˆ†æåŠŸèƒ½",
                plan7days: "7å¤©æ–¹æ¡ˆ",
                plan20days: "20å¤©æ–¹æ¡ˆ",
                price980: "Â¥980",
                price1980: "Â¥1,980",
                duration7days: "1é€±ç„¡é™åˆ¶",
                duration20days: "20å¤©ç„¡é™åˆ¶",
                featureUnlimited: "AIåˆ†æç„¡é™åˆ¶",
                featurePriority: "é«˜å„ªå…ˆç´šè™•ç†",
                featureReport: "è©³ç´°åˆ†æå ±å‘Š",
                proceedPayment: "é€²è¡Œä»˜æ¬¾",
                cancelPayment: "å–æ¶ˆ",
                popularPlan: "ç†±é–€æ–¹æ¡ˆ",
                paymentPreparation: "ğŸ’³ æ­£åœ¨è·³è½‰è‡³ä»˜æ¬¾é é¢...",
                stripeRedirect: "æ­£åœ¨è·³è½‰è‡³å®‰å…¨çš„Stripeä»˜æ¬¾é é¢...",
                paymentSecurity: "ğŸ”’ SSLåŠ å¯†é€šè¨Šãƒ»Stripeå®‰å…¨ä»˜æ¬¾"
            },
            en: {
                title: "Tourism Analyzer",
                description: "AI analysis of tourism and gourmet images with local insights",
                languageSelect: "Select Analysis Language",
                analysisTypeSelect: "Select Analysis Type",
                storeAnalysis: "Storeãƒ»Tourism Analysis",
                menuTranslation: "Signboardãƒ»Menu Translation", 
                uploadText: "Upload Image",
                uploadSubtext: "Click or drag & drop photos of stores, tourist spots, and cuisine",
                fileFormat: "Supported formats: JPG, PNG, GIF (max 10MB)",
                storeRecommended: "Recommended: Local specialties, tourist attractions, events, etc.",
                menuRecommended: "Especially effective: Handwritten menus, price lists, order forms, etc.",
                previewTitle: "Upload Image Preview",
                analyzeButton: "Start Tourism AI Analysis",
                loading: "Tourism AI Analyzing...",
                loadingSubtext: "Local Cuisineãƒ»Tourist Spotsãƒ»Regional Information",
                loadingDetail: "Analyzing detailed local information",
                loginTitle: "Tourism Analyzer",
                loginUsername: "User ID", 
                loginPassword: "Password",
                loginButton: "Login",
                googleLogin: "Login with Google",
                googleRedirecting: "Redirecting to Google...",
                emailLogin: "Login with Email",
                orDivider: "or",
                loginProcessing: "Authenticating...",
                signupPrompt: "Don't have an account?",
                signupLink: "Sign up",
                forgotPassword: "Forgot password?",
                confirmPassword: "Confirm Password",
                signup: "Sign Up",
                backToLogin: "Back to Login",
                googleLoginNotReady: "Google login is currently being configured. Please use email login.",
                currentUser: "ãƒ¦ãƒ¼ã‚¶ãƒ¼",
                logout: "Logout",
                newAnalysis: "New Analysis",
                startText: "Start",
                // Premium Modal
                upgradeTitle: "â­ Upgrade to Premium Plan",
                upgradeDescription: "Enjoy unlimited AI analysis",
                plan7days: "7-Day Plan",
                plan20days: "20-Day Plan",
                price980: "Â¥980",
                price1980: "Â¥1,980",
                duration7days: "1 Week Unlimited",
                duration20days: "20 Days Unlimited",
                featureUnlimited: "Unlimited AI Analysis",
                featurePriority: "High Priority Processing",
                featureReport: "Detailed Analysis Reports",
                proceedPayment: "Proceed to Payment",
                cancelPayment: "Cancel",
                popularPlan: "Popular Plan",
                paymentPreparation: "ğŸ’³ Redirecting to payment page...",
                stripeRedirect: "Redirecting to secure Stripe payment page...",
                paymentSecurity: "ğŸ”’ SSL Encrypted Communicationãƒ»Secure Stripe Payment"
            }
        };

        // ãƒ¡ãƒ¼ãƒ«èªè¨¼ç”»é¢å°‚ç”¨ã®ç¿»è¨³ãƒ‡ãƒ¼ã‚¿ï¼ˆPhase 6.9.5ï¼‰
        const emailAuthTranslations = {
            ja: {
                emailLogin: "ğŸ“§ ãƒ¡ãƒ¼ãƒ«ã§ãƒ­ã‚°ã‚¤ãƒ³",
                loginTitle: "è¦³å…‰ã‚¢ãƒŠãƒ©ã‚¤ã‚¶ãƒ¼ã«ãƒ­ã‚°ã‚¤ãƒ³", 
                emailPlaceholder: "ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹",
                passwordPlaceholder: "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰",
                confirmPassword: "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç¢ºèª",
                loginButton: "ãƒ­ã‚°ã‚¤ãƒ³",
                signupButton: "æ–°è¦ç™»éŒ²",
                signupLink: "æ–°è¦ç™»éŒ²",
                forgotPassword: "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¿˜ã‚ŒãŸæ–¹",
                languageSelect: "è¨€èªã‚’é¸æŠ"
            },
            ko: {
                emailLogin: "ğŸ“§ ì´ë©”ì¼ë¡œ ë¡œê·¸ì¸",
                loginTitle: "ê´€ê´‘ ë¶„ì„ê¸°ì— ë¡œê·¸ì¸",
                emailPlaceholder: "ì´ë©”ì¼ ì£¼ì†Œ", 
                passwordPlaceholder: "ë¹„ë°€ë²ˆí˜¸",
                confirmPassword: "ë¹„ë°€ë²ˆí˜¸ í™•ì¸",
                loginButton: "ë¡œê·¸ì¸",
                signupButton: "íšŒì›ê°€ì…",
                signupLink: "íšŒì›ê°€ì…",
                forgotPassword: "ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸°",
                languageSelect: "ì–¸ì–´ ì„ íƒ"
            },
            zh: {
                emailLogin: "ğŸ“§ ä½¿ç”¨é‚®ç®±ç™»å½•",
                loginTitle: "ç™»å½•æ—…æ¸¸åˆ†æå™¨",
                emailPlaceholder: "é‚®ç®±åœ°å€",
                passwordPlaceholder: "å¯†ç ",
                confirmPassword: "ç¡®è®¤å¯†ç ", 
                loginButton: "ç™»å½•",
                signupButton: "æ³¨å†Œè´¦æˆ·",
                signupLink: "æ³¨å†Œè´¦æˆ·",
                forgotPassword: "å¿˜è®°å¯†ç ï¼Ÿ",
                languageSelect: "é€‰æ‹©è¯­è¨€"
            },
            tw: {
                emailLogin: "ğŸ“§ ä½¿ç”¨é›»å­éƒµä»¶ç™»å…¥",
                loginTitle: "ç™»å…¥è§€å…‰åˆ†æå™¨",
                emailPlaceholder: "é›»å­éƒµä»¶åœ°å€",
                passwordPlaceholder: "å¯†ç¢¼",
                confirmPassword: "ç¢ºèªå¯†ç¢¼",
                loginButton: "ç™»å…¥",
                signupButton: "è¨»å†Šå¸³è™Ÿ", 
                signupLink: "è¨»å†Šå¸³è™Ÿ",
                forgotPassword: "å¿˜è¨˜å¯†ç¢¼ï¼Ÿ",
                languageSelect: "é¸æ“‡èªè¨€"
            },
            en: {
                emailLogin: "ğŸ“§ Sign in with Email",
                loginTitle: "Sign in to Tourism Analyzer",
                emailPlaceholder: "Email address",
                passwordPlaceholder: "Password",
                confirmPassword: "Confirm Password",
                loginButton: "Sign in",
                signupButton: "Sign up",
                signupLink: "Sign up", 
                forgotPassword: "Forgot password?",
                languageSelect: "Select language"
            }
        };

        // DOM Elements
        const loginSection = document.getElementById('loginSection');
        const mainApp = document.getElementById('mainApp');
        const userInfo = document.getElementById('userInfo');
        const uploadSection = document.getElementById('uploadSection');
        const previewSection = document.getElementById('previewSection');
        const loadingSection = document.getElementById('loadingSection');
        const resultsSection = document.getElementById('resultsSection');

        // Initialize
        document.addEventListener('DOMContentLoaded', init);

        function init() {
            console.log('ğŸš€ Initializing application...');
            
            // æ±ºæ¸ˆå®Œäº†å‡¦ç†ã‚’ãƒã‚§ãƒƒã‚¯
            handlePaymentResult();
            
            // ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®åˆ©ç”¨å¯èƒ½æ€§ã‚’ãƒã‚§ãƒƒã‚¯
            const isMarkedAvailable = typeof marked !== 'undefined';
            const isDOMPurifyAvailable = typeof DOMPurify !== 'undefined';
            
            console.log('ğŸ“š Library status at init:', {
                marked: isMarkedAvailable,
                DOMPurify: isDOMPurifyAvailable
            });
            
            if (!isMarkedAvailable) {
                console.error('âŒ marked.js is not loaded! Markdown parsing will fail.');
            }
            
            if (!isDOMPurifyAvailable) {
                console.warn('âš ï¸ DOMPurify is not loaded! XSS vulnerability exists.');
            }
            
            setupEventListeners();
            handleOAuthCallback();
            // checkOldAuthStatus(); // å¤ã„èªè¨¼ã‚·ã‚¹ãƒ†ãƒ ï¼ˆç¾åœ¨æœªä½¿ç”¨ï¼‰
            initializeLanguage();
            
            // marked.jsãŒåˆ©ç”¨å¯èƒ½ãªå ´åˆã®ã¿MarkdownåˆæœŸåŒ–
            if (isMarkedAvailable) {
                initializeMarkdown();
                console.log('âœ… Markdown initialized successfully');
            } else {
                console.log('âš ï¸ Markdown initialization skipped - library not available');
            }
            
            // Update user info display if already logged in
            if (sessionStorage.getItem('authToken')) {
                updateHeaderUserInfo();
            }
            
            console.log('âœ… Application initialization complete');
        }
        
        // Initialize Markdown configuration
        function initializeMarkdown() {
            try {
                console.log('ğŸ”§ Configuring marked.js options...');
                
                // Markedã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³è¨­å®š
                marked.setOptions({
                    breaks: true,        // æ”¹è¡Œã‚’<br>ã«å¤‰æ›
                    gfm: true,          // GitHub Flavored Markdownæœ‰åŠ¹
                    headerIds: false,   // ãƒ˜ãƒƒãƒ€ãƒ¼IDã‚’ç”Ÿæˆã—ãªã„
                    mangle: false,      // emailã‚¢ãƒ‰ãƒ¬ã‚¹ã®è‡ªå‹•ãƒªãƒ³ã‚¯ã‚’ç„¡åŠ¹
                    sanitize: false     // HTMLã‚µãƒ‹ã‚¿ã‚¤ã‚ºã¯DOMPurifyã§è¡Œã†
                });
                
                console.log('ğŸ¨ Setting up custom renderer...');
                
                // ã‚«ã‚¹ã‚¿ãƒ ãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼è¨­å®š
                const renderer = new marked.Renderer();
                
                // ã‚«ã‚¹ã‚¿ãƒ ãƒªãƒ³ã‚¯ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ï¼ˆå¤–éƒ¨ãƒªãƒ³ã‚¯ã¯æ–°ã—ã„ã‚¿ãƒ–ã§é–‹ãï¼‰
                renderer.link = function(href, title, text) {
                    const isExternal = href.startsWith('http');
                    const target = isExternal ? ' target="_blank" rel="noopener noreferrer"' : '';
                    const titleAttr = title ? ` title="${title}"` : '';
                    return `<a href="${href}"${titleAttr}${target}>${text}</a>`;
                };
                
                // ã‚«ã‚¹ã‚¿ãƒ ãƒ†ãƒ¼ãƒ–ãƒ«ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚°
                renderer.table = function(header, body) {
                    return `<div class="table-container">
                        <table class="markdown-table">
                            <thead>${header}</thead>
                            <tbody>${body}</tbody>
                        </table>
                    </div>`;
                };
                
                marked.setOptions({ renderer });
                
                console.log('âœ… marked.js configuration completed successfully');
                
                // ãƒ†ã‚¹ãƒˆç”¨ã®Markdownè§£æ
                const testMarkdown = '## Test\n**Bold text** and *italic text*\n- List item 1\n- List item 2';
                const testResult = marked.parse(testMarkdown);
                console.log('ğŸ§ª Markdown test:', { input: testMarkdown, output: testResult });
                
            } catch (error) {
                console.error('âŒ Error during Markdown initialization:', error);
            }
        }

        // Handle OAuth callback from Cognito
        async function handleOAuthCallback() {
            const urlParams = new URLSearchParams(window.location.search);
            const authCode = urlParams.get('code');
            
            if (authCode) {
                try {
                    showMessage('Googleãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†ä¸­...', 'info');
                    
                    // Exchange authorization code for tokens
                    const tokenResponse = await fetch('https://ai-tourism-auth.auth.ap-northeast-1.amazoncognito.com/oauth2/token', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: new URLSearchParams({
                            grant_type: 'authorization_code',
                            client_id: '2tctru78c2epl4mbhrt8asd55e',
                            code: authCode,
                            redirect_uri: window.location.origin + window.location.pathname
                        })
                    });

                    if (tokenResponse.ok) {
                        const tokens = await tokenResponse.json();
                        
                        // Get user info from token
                        const userInfoResponse = await fetch('https://ai-tourism-auth.auth.ap-northeast-1.amazoncognito.com/oauth2/userInfo', {
                            headers: {
                                'Authorization': `Bearer ${tokens.access_token}`
                            }
                        });

                        if (userInfoResponse.ok) {
                            const userInfo = await userInfoResponse.json();
                            
                            // Store tokens and user info
                            sessionStorage.setItem('accessToken', tokens.access_token);
                            sessionStorage.setItem('userInfo', JSON.stringify({
                                user_id: userInfo.sub,
                                email: userInfo.email,
                                display_name: userInfo.name || userInfo.given_name,
                                picture: userInfo.picture
                            }));
                            sessionStorage.setItem('tourismAuth', 'true');
                            sessionStorage.setItem('tourismUser', userInfo.email);

                            // Create user in DynamoDB if needed
                            await createUserIfNeeded({
                                user_id: userInfo.sub,
                                email: userInfo.email,
                                display_name: userInfo.name || userInfo.given_name,
                                auth_provider: 'google'
                            });

                            isLoggedIn = true;
                            showMessage('Googleãƒ­ã‚°ã‚¤ãƒ³ã«æˆåŠŸã—ã¾ã—ãŸï¼', 'success');
                            
                            // Hide login screen and show main app
                            showMainApp();
                            updateHeaderUserInfo();
                        }
                    } else {
                        throw new Error('Token exchange failed');
                    }
                } catch (error) {
                    console.error('OAuth callback error:', error);
                    showMessage('Googleãƒ­ã‚°ã‚¤ãƒ³ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
                }
                
                // Clean up URL
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        }

        function setupEventListeners() {
            // Google login
            const googleLoginBtn = document.getElementById('googleLoginBtn');
            if (googleLoginBtn) {
                googleLoginBtn.addEventListener('click', handleGoogleLogin);
            }
            
            // Email login button
            const emailLoginBtn = document.getElementById('emailLoginBtn');
            if (emailLoginBtn) {
                emailLoginBtn.addEventListener('click', handleEmailLogin);
            }
            
            // Original login form (fallback)
            const loginForm = document.getElementById('loginForm');
            if (loginForm) {
                loginForm.addEventListener('submit', handleLogin);
            }

            // File input
            const imageInput = document.getElementById('imageInput');
            if (imageInput) {
                imageInput.addEventListener('change', handleFileSelect);
            }

            // Drag and drop
            if (uploadSection) {
                uploadSection.addEventListener('dragover', handleDragOver);
                uploadSection.addEventListener('drop', handleDrop);
                uploadSection.addEventListener('dragleave', handleDragLeave);
            }

            // Language change listeners
            document.querySelectorAll('input[name="language"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    updateUILanguage(e.target.value);
                });
            });

            // Analysis type change listeners
            document.querySelectorAll('input[name="analysisType"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    updateRecommendedText(e.target.value);
                });
            });
        }

        // UI Language Update Functions
        function updateUILanguage(language) {
            const t = translations[language];
            if (!t) return;

            // Update all elements with data-i18n attributes
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                if (t[key]) {
                    // Handle different element types
                    if (element.tagName === 'INPUT' && element.type === 'text') {
                        element.placeholder = t[key];
                    } else if (element.tagName === 'INPUT' && element.type === 'password') {
                        element.placeholder = t[key];
                    } else {
                        // Preserve emojis and icons at the beginning of text
                        const currentText = element.textContent;
                        const emojiMatch = currentText.match(/^[\u{1F000}-\u{1F6FF}\u{1F700}-\u{1F77F}\u{1F780}-\u{1F7FF}\u{1F800}-\u{1F8FF}\u{1F900}-\u{1F9FF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}]+\s*/u);
                        const emoji = emojiMatch ? emojiMatch[0] : '';
                        element.textContent = emoji + t[key];
                    }
                }
            });

            // Update document language attribute
            document.documentElement.lang = language;

            // Update font family based on language
            updateFontFamily(language);

            // Store selected language in sessionStorage
            sessionStorage.setItem('selectedLanguage', language);

            // Update recommended text based on current analysis type
            const currentAnalysisType = document.querySelector('input[name="analysisType"]:checked')?.value || 'store';
            updateRecommendedText(currentAnalysisType);
        }

        function updateRecommendedText(analysisType) {
            const currentLanguage = sessionStorage.getItem('selectedLanguage') || 'ja';
            const t = translations[currentLanguage];
            const recommendedElement = document.getElementById('recommendedText');
            
            if (recommendedElement && t) {
                if (analysisType === 'menu') {
                    recommendedElement.textContent = t.menuRecommended;
                    recommendedElement.setAttribute('data-i18n', 'menuRecommended');
                } else {
                    recommendedElement.textContent = t.storeRecommended;
                    recommendedElement.setAttribute('data-i18n', 'storeRecommended');
                }
            }
        }

        function updateFontFamily(language) {
            const body = document.body;
            switch (language) {
                case 'ko':
                    body.style.fontFamily = "'Noto Sans KR', 'Malgun Gothic', 'Apple SD Gothic Neo', sans-serif";
                    break;
                case 'zh':
                    body.style.fontFamily = "'Noto Sans SC', 'Microsoft YaHei', 'PingFang SC', sans-serif";
                    break;
                case 'en':
                    body.style.fontFamily = "'Inter', 'Roboto', 'Segoe UI', sans-serif";
                    break;
                default: // ja
                    body.style.fontFamily = "'BIZ UDPGothic', 'BIZ UDGothic', 'Hiragino Sans', 'Yu Gothic UI', sans-serif";
            }
        }

        function initializeLanguage() {
            // Load saved language or default to Japanese
            const savedLanguage = sessionStorage.getItem('selectedLanguage') || 'ja';
            const languageRadio = document.querySelector(`input[name="language"][value="${savedLanguage}"]`);
            if (languageRadio) {
                languageRadio.checked = true;
                updateUILanguage(savedLanguage);
            }
        }

        // Authentication
        function handleGoogleLogin() {
            // Add loading state to button
            const googleBtn = document.getElementById('googleLoginBtn');
            const originalHTML = googleBtn.innerHTML;
            
            // Get current language for loading text
            const currentLanguage = sessionStorage.getItem('selectedLanguage') || 'ja';
            const t = translations[currentLanguage];
            
            // Set loading state with enhanced UI
            googleBtn.innerHTML = `
                <div class="loading-spinner"></div>
                <span>${t.googleRedirecting}</span>
            `;
            googleBtn.disabled = true;
            googleBtn.classList.add('loading');
            
            // Auto-logout before Google login to ensure clean session
            console.log('ğŸš¨ Auto-logout before Google login...');
            
            // Clear all existing sessions and tokens
            isLoggedIn = false;
            sessionStorage.removeItem('tourismAuth');
            sessionStorage.removeItem('tourismUser');
            sessionStorage.removeItem('accessToken');
            sessionStorage.removeItem('userInfo');
            sessionStorage.removeItem('emergency-login-token');
            localStorage.removeItem('tourismAuth');
            localStorage.removeItem('tourismUser');
            localStorage.removeItem('accessToken');
            localStorage.removeItem('userInfo');
            
            console.log('âœ… Session cleared, proceeding to Google OAuth...');
            
            // Add slight delay for better UX
            setTimeout(() => {
                // Use Cognito OAuth but with better UX
                const cognitoOAuthURL = `https://ai-tourism-auth.auth.ap-northeast-1.amazoncognito.com/login` +
                    `?client_id=2tctru78c2epl4mbhrt8asd55e` +
                    `&response_type=code` +
                    `&scope=email+openid+profile` +
                    `&redirect_uri=${encodeURIComponent(window.location.origin + window.location.pathname)}` +
                    `&identity_provider=Google` +
                    `&prompt=select_account`; // Force account selection for better UX
                
                console.log('ğŸš€ Redirecting to Cognito Google OAuth:', cognitoOAuthURL);
                window.location.href = cognitoOAuthURL;
            }, 800);
        }
        
        function handleEmailLogin(e) {
            if (e) e.preventDefault();
            showEmailAuthForm();
        }
        
        function showEmailAuthForm() {
            const currentLanguage = sessionStorage.getItem('selectedLanguage') || 'ja';
            const t = emailAuthTranslations[currentLanguage] || emailAuthTranslations['ja'];
            
            const loginCard = document.querySelector('.login-card');
            loginCard.innerHTML = `
                <h1 class="login-title">ğŸ”ï¸</h1>
                <h2 class="login-subtitle" data-i18n="loginTitle">${t.loginTitle}</h2>
                
                <!-- è¨€èªé¸æŠ -->
                <div class="language-selector" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem; margin-bottom: 1.5rem; font-size: 0.85rem;">
                    <label style="display: flex; align-items: center; gap: 0.3rem;"><input type="radio" name="authLang" value="ja" ${currentLanguage === 'ja' ? 'checked' : ''}> ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª</label>
                    <label style="display: flex; align-items: center; gap: 0.3rem;"><input type="radio" name="authLang" value="ko" ${currentLanguage === 'ko' ? 'checked' : ''}> ğŸ‡°ğŸ‡· í•œêµ­ì–´</label>
                    <label style="display: flex; align-items: center; gap: 0.3rem;"><input type="radio" name="authLang" value="zh" ${currentLanguage === 'zh' ? 'checked' : ''}> ğŸ‡¨ğŸ‡³ ç®€ä½“ä¸­æ–‡</label>
                    <label style="display: flex; align-items: center; gap: 0.3rem;"><input type="radio" name="authLang" value="tw" ${currentLanguage === 'tw' ? 'checked' : ''}> ğŸ‡¹ğŸ‡¼ ç¹é«”ä¸­æ–‡</label>
                    <label style="display: flex; align-items: center; gap: 0.3rem;"><input type="radio" name="authLang" value="en" ${currentLanguage === 'en' ? 'checked' : ''}> ğŸŒ English</label>
                </div>
                
                <!-- ãƒ­ã‚°ã‚¤ãƒ³/ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—åˆ‡ã‚Šæ›¿ãˆ -->
                <div class="auth-mode-switcher" style="display: flex; margin-bottom: 2rem; border-radius: 25px; background: #f5f5f5; overflow: hidden;">
                    <button id="loginModeBtn" class="mode-btn active" style="flex: 1; padding: 0.8rem; border: none; background: var(--primary-color); color: white; font-weight: 600; cursor: pointer;" data-i18n="loginButton">${t.loginButton}</button>
                    <button id="signupModeBtn" class="mode-btn" style="flex: 1; padding: 0.8rem; border: none; background: transparent; color: #666; font-weight: 600; cursor: pointer;" data-i18n="signupButton">${t.signupButton}</button>
                </div>
                
                <!-- ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ  -->
                <form id="loginForm" style="display: block;">
                    <div class="form-group" style="text-align: left; margin-bottom: 1rem;">
                        <input type="email" id="loginEmail" placeholder="${t.emailPlaceholder}" required 
                               style="width: 100%; padding: 1rem; border: 2px solid #e1e5e9; border-radius: 12px; font-size: 1rem; box-sizing: border-box;">
                    </div>
                    <div class="form-group" style="text-align: left; margin-bottom: 1.5rem;">
                        <input type="password" id="loginPassword" placeholder="${t.passwordPlaceholder}" required
                               style="width: 100%; padding: 1rem; border: 2px solid #e1e5e9; border-radius: 12px; font-size: 1rem; box-sizing: border-box;">
                    </div>
                    <button type="submit" style="width: 100%; padding: 1rem; background: var(--primary-color); color: white; border: none; border-radius: 12px; font-size: 1.1rem; font-weight: 600; cursor: pointer; margin-bottom: 1rem;" data-i18n="loginButton">${t.loginButton}</button>
                </form>
                
                <!-- ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ãƒ•ã‚©ãƒ¼ãƒ  -->
                <form id="signupForm" style="display: none;">
                    <div class="form-group" style="text-align: left; margin-bottom: 1rem;">
                        <input type="email" id="signupEmail" placeholder="${t.emailPlaceholder}" required
                               style="width: 100%; padding: 1rem; border: 2px solid #e1e5e9; border-radius: 12px; font-size: 1rem; box-sizing: border-box;">
                    </div>
                    <div class="form-group" style="text-align: left; margin-bottom: 1rem;">
                        <input type="password" id="signupPassword" placeholder="${t.passwordPlaceholder}" required minlength="8"
                               style="width: 100%; padding: 1rem; border: 2px solid #e1e5e9; border-radius: 12px; font-size: 1rem; box-sizing: border-box;">
                    </div>
                    <div class="form-group" style="text-align: left; margin-bottom: 1.5rem;">
                        <input type="password" id="confirmPassword" placeholder="${t.confirmPassword}" required
                               style="width: 100%; padding: 1rem; border: 2px solid #e1e5e9; border-radius: 12px; font-size: 1rem; box-sizing: border-box;">
                    </div>
                    <button type="submit" style="width: 100%; padding: 1rem; background: var(--secondary-color); color: white; border: none; border-radius: 12px; font-size: 1.1rem; font-weight: 600; cursor: pointer; margin-bottom: 1rem;" data-i18n="signupButton">${t.signupButton}</button>
                </form>
                
                <!-- ç·Šæ€¥ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ -->
                <button onclick="showEmergencyLogin()" style="width: 100%; padding: 0.8rem; background: #ff9800; color: white; border: none; border-radius: 12px; font-size: 0.9rem; cursor: pointer; margin-bottom: 0.5rem;">ğŸˆ­ PoCç·Šæ€¥ãƒ­ã‚°ã‚¤ãƒ³ (Phase5.5åŒæ§˜)</button>
                
                <button onclick="backToMainLogin()" style="width: 100%; padding: 0.8rem; background: transparent; color: #666; border: 1px solid #ddd; border-radius: 12px; font-size: 1rem; cursor: pointer;" data-i18n="backToLogin">${t.backToLogin}</button>
            `;
            
            setupAuthFormListeners();
        }
        
        async function sendVerificationCode(email) {
            // This would integrate with Cognito's email verification
            return new Promise((resolve) => {
                setTimeout(() => {
                    console.log('Verification code sent to:', email);
                    resolve();
                }, 1000);
            });
        }
        
        function showVerificationCodeInput(email) {
            document.getElementById('loginSection').innerHTML = `
                <h3>èªè¨¼ã‚³ãƒ¼ãƒ‰å…¥åŠ›</h3>
                <p>${email} ã«èªè¨¼ã‚³ãƒ¼ãƒ‰ã‚’é€ä¿¡ã—ã¾ã—ãŸ</p>
                <form onsubmit="handleVerificationCode(event, '${email}')">
                    <input type="text" id="verificationCode" placeholder="èªè¨¼ã‚³ãƒ¼ãƒ‰" required maxlength="6">
                    <button type="submit" id="verifyBtn">èªè¨¼</button>
                    <button type="button" onclick="backToLogin()">æˆ»ã‚‹</button>
                </form>
            `;
        }
        
        function handleVerificationCode(e, email) {
            e.preventDefault();
            const code = document.getElementById('verificationCode').value;
            
            // Here we would verify with Cognito
            console.log('Verifying code:', code, 'for email:', email);
            
            // Mock successful login for now
            isLoggedIn = true;
            sessionStorage.setItem('tourismAuth', 'true');
            sessionStorage.setItem('tourismUser', email);
            showMainApp();
        }
        
        function backToMainLogin() {
            location.reload();
        }
        
        function showEmergencyLogin() {
            const currentLanguage = sessionStorage.getItem('selectedLanguage') || 'ja';
            const t = translations[currentLanguage];
            
            const loginCard = document.querySelector('.login-card');
            loginCard.innerHTML = `
                <h1 class="login-title">ğŸˆ­</h1>
                <h2 class="login-subtitle">PoCç·Šæ€¥ãƒ­ã‚°ã‚¤ãƒ³ (Phase5.5)</h2>
                <p style="color: #666; margin-bottom: 2rem; font-size: 0.9rem;">é–‹ç™ºãƒ†ã‚¹ãƒˆç”¨ã®ç°¡æ˜“ãƒ­ã‚°ã‚¤ãƒ³ã§ã™</p>
                
                <form id="emergencyLoginForm">
                    <div class="form-group" style="text-align: left; margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #333;">ãƒ¦ãƒ¼ã‚¶ãƒ¼ID:</label>
                        <input type="text" id="emergencyUsername" value="sapporo-guide" 
                               style="width: 100%; padding: 1rem; border: 2px solid #e1e5e9; border-radius: 12px; font-size: 1rem; box-sizing: border-box;">
                    </div>
                    <div class="form-group" style="text-align: left; margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #333;">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰:</label>
                        <input type="password" id="emergencyPassword" value="hokkaido2024"
                               style="width: 100%; padding: 1rem; border: 2px solid #e1e5e9; border-radius: 12px; font-size: 1rem; box-sizing: border-box;">
                    </div>
                    <button type="submit" style="width: 100%; padding: 1rem; background: #ff9800; color: white; border: none; border-radius: 12px; font-size: 1.1rem; font-weight: 600; cursor: pointer; margin-bottom: 1rem;">ç·Šæ€¥ãƒ­ã‚°ã‚¤ãƒ³</button>
                </form>
                
                <button onclick="backToMainLogin()" style="width: 100%; padding: 0.8rem; background: transparent; color: #666; border: 1px solid #ddd; border-radius: 12px; font-size: 1rem; cursor: pointer;">æˆ»ã‚‹</button>
            `;
            
            // ç·Šæ€¥ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ ã®ãƒªã‚¹ãƒŠãƒ¼
            const emergencyLoginForm = document.getElementById('emergencyLoginForm');
            if (emergencyLoginForm) {
                emergencyLoginForm.addEventListener('submit', handleEmergencyLogin);
            }
        }
        
        function setupAuthFormListeners() {
            // è¨€èªå¤‰æ›´ãƒªã‚¹ãƒŠãƒ¼
            document.querySelectorAll('input[name="authLang"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    sessionStorage.setItem('selectedLanguage', this.value);
                    showEmailAuthForm(); // å†æç”»
                });
            });
            
            // ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ
            const loginModeBtn = document.getElementById('loginModeBtn');
            const signupModeBtn = document.getElementById('signupModeBtn');
            const loginForm = document.getElementById('loginForm');
            const signupForm = document.getElementById('signupForm');
            
            if (loginModeBtn && signupModeBtn && loginForm && signupForm) {
                loginModeBtn.addEventListener('click', function() {
                    loginForm.style.display = 'block';
                    signupForm.style.display = 'none';
                    this.style.background = 'var(--primary-color)';
                    this.style.color = 'white';
                    signupModeBtn.style.background = 'transparent';
                    signupModeBtn.style.color = '#666';
                });
                
                signupModeBtn.addEventListener('click', function() {
                    loginForm.style.display = 'none';
                    signupForm.style.display = 'block';
                    this.style.background = 'var(--secondary-color)';
                    this.style.color = 'white';
                    loginModeBtn.style.background = 'transparent';
                    loginModeBtn.style.color = '#666';
                });
                
                // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ãƒªã‚¹ãƒŠãƒ¼
                loginForm.addEventListener('submit', handleCognitoLogin);
                signupForm.addEventListener('submit', handleCognitoSignup);
            }
        }
        
        async function handleCognitoLogin(e) {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const submitBtn = e.target.querySelector('button[type="submit"]');
            
            const currentLanguage = sessionStorage.getItem('selectedLanguage') || 'ja';
            const t = translations[currentLanguage];
            
            if (!email || !password) {
                alert(t.googleLoginNotReady || 'ã™ã¹ã¦ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            submitBtn.disabled = true;
            submitBtn.textContent = t.loginProcessing;
            
            try {
                const response = await fetch(`${API_BASE_URL}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: email,
                        password: password
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ
                    sessionStorage.setItem('accessToken', data.tokens.AccessToken);
                    sessionStorage.setItem('userInfo', JSON.stringify(data.user_info));
                    sessionStorage.setItem('tourismAuth', 'true');
                    sessionStorage.setItem('sapporoUser', data.user_info.email);
                    
                    isLoggedIn = true;
                    showMainApp();
                    updateHeaderUserInfo(); // Update user info and plan display
                    showMessage('ãƒ­ã‚°ã‚¤ãƒ³ã«æˆåŠŸã—ã¾ã—ãŸ', 'success');
                } else {
                    if (data.error.includes('User not confirmed')) {
                        showConfirmationCodeInput(email, password);
                        showMessage('ãƒ¡ãƒ¼ãƒ«èªè¨¼ãŒå¿…è¦ã§ã™ã€‚ãƒ¡ãƒ¼ãƒ«ã‚’ã”ç¢ºèªãã ã•ã„', 'info');
                    } else {
                        throw new Error(data.error || 'ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    }
                }
            } catch (error) {
                console.error('Login error:', error);
                showMessage('ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = t.loginButton;
            }
        }
        
        async function handleCognitoSignup(e) {
            e.preventDefault();
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const submitBtn = e.target.querySelector('button[type="submit"]');
            
            const currentLanguage = sessionStorage.getItem('selectedLanguage') || 'ja';
            const t = translations[currentLanguage];
            
            if (!email || !password || !confirmPassword) {
                showMessage('ã™ã¹ã¦ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }
            
            if (password !== confirmPassword) {
                showMessage('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“', 'error');
                return;
            }
            
            if (password.length < 8) {
                showMessage('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯8æ–‡å­—ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }
            
            submitBtn.disabled = true;
            submitBtn.textContent = t.loginProcessing || 'ç™»éŒ²ä¸­...';
            
            try {
                const response = await fetch(`${API_BASE_URL}/auth/signup`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: email,
                        password: password,
                        display_name: email.split('@')[0]
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    if (data.confirmation_required) {
                        showConfirmationCodeInput(email, password);
                        showMessage('ãƒ¡ãƒ¼ãƒ«ã«èªè¨¼ã‚³ãƒ¼ãƒ‰ã‚’é€ä¿¡ã—ã¾ã—ãŸ', 'success');
                    }
                } else {
                    if (data.error.includes('User already exists')) {
                        showMessage('ã“ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯æ—¢ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™', 'error');
                    } else {
                        throw new Error(data.error || 'æ–°è¦ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    }
                }
            } catch (error) {
                console.error('Signup error:', error);
                showMessage('ç™»éŒ²ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = t.signup || 'æ–°è¦ç™»éŒ²';
            }
        }
        
        function showConfirmationCodeInput(email, password) {
            const currentLanguage = sessionStorage.getItem('selectedLanguage') || 'ja';
            const t = translations[currentLanguage];
            
            const loginCard = document.querySelector('.login-card');
            loginCard.innerHTML = `
                <h1 class="login-title">ğŸ“§</h1>
                <h2 class="login-subtitle">ãƒ¡ãƒ¼ãƒ«èªè¨¼</h2>
                <p style="text-align: center; color: #666; margin-bottom: 2rem;">
                    <strong>${email}</strong><br>
                    ã«èªè¨¼ã‚³ãƒ¼ãƒ‰ã‚’é€ä¿¡ã—ã¾ã—ãŸ
                </p>
                
                <form id="confirmationForm" onsubmit="handleConfirmationCode(event, '${email}', '${password}')">
                    <div class="form-group" style="text-align: left; margin-bottom: 1.5rem;">
                        <input type="text" id="confirmationCode" placeholder="èªè¨¼ã‚³ãƒ¼ãƒ‰ (6æ¡)" required maxlength="6"
                               style="width: 100%; padding: 1rem; border: 2px solid #e1e5e9; border-radius: 12px; font-size: 1.2rem; text-align: center; letter-spacing: 0.2rem; box-sizing: border-box;">
                    </div>
                    <button type="submit" id="verifyBtn" style="width: 100%; padding: 1rem; background: var(--primary-color); color: white; border: none; border-radius: 12px; font-size: 1.1rem; font-weight: 600; cursor: pointer; margin-bottom: 1rem;">
                        èªè¨¼ã‚³ãƒ¼ãƒ‰ç¢ºèª
                    </button>
                </form>
                
                <button onclick="resendConfirmationCode('${email}')" style="width: 100%; padding: 0.8rem; background: transparent; color: var(--primary-color); border: 1px solid var(--primary-color); border-radius: 12px; font-size: 1rem; cursor: pointer; margin-bottom: 1rem;">
                    èªè¨¼ã‚³ãƒ¼ãƒ‰ã‚’å†é€ä¿¡
                </button>
                
                <button onclick="backToMainLogin()" style="width: 100%; padding: 0.8rem; background: transparent; color: #666; border: 1px solid #ddd; border-radius: 12px; font-size: 1rem; cursor: pointer;">
                    ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«æˆ»ã‚‹
                </button>
            `;
            
            // Focus on the confirmation code input
            setTimeout(() => {
                document.getElementById('confirmationCode').focus();
            }, 100);
        }

        async function handleConfirmationCode(e, email, password) {
            e.preventDefault();
            
            const confirmationCode = document.getElementById('confirmationCode').value;
            const submitBtn = e.target.querySelector('button[type="submit"]');
            
            submitBtn.disabled = true;
            submitBtn.textContent = 'èªè¨¼ä¸­...';
            
            try {
                const response = await fetch(`${API_BASE_URL}/auth/confirm-signup`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: email,
                        confirmation_code: confirmationCode,
                        password: password
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // Confirmation successful, auto-login
                    sessionStorage.setItem('accessToken', data.tokens.AccessToken);
                    sessionStorage.setItem('userInfo', JSON.stringify(data.user_info));
                    sessionStorage.setItem('tourismAuth', 'true');
                    sessionStorage.setItem('sapporoUser', data.user_info.email);
                    
                    isLoggedIn = true;
                    showMainApp();
                    updateHeaderUserInfo(); // Update user info and plan display
                    showMessage('ãƒ¡ãƒ¼ãƒ«èªè¨¼ãŒå®Œäº†ã—ã¾ã—ãŸï¼ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸ', 'success');
                } else {
                    if (data.error.includes('Invalid confirmation code')) {
                        showMessage('èªè¨¼ã‚³ãƒ¼ãƒ‰ãŒé–“é•ã£ã¦ã„ã¾ã™', 'error');
                    } else if (data.error.includes('Confirmation code expired')) {
                        showMessage('èªè¨¼ã‚³ãƒ¼ãƒ‰ã®æœŸé™ãŒåˆ‡ã‚Œã¾ã—ãŸã€‚å†é€ä¿¡ã—ã¦ãã ã•ã„', 'error');
                    } else {
                        showMessage(data.error, 'error');
                    }
                }
            } catch (error) {
                console.error('Confirmation error:', error);
                showMessage('èªè¨¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'èªè¨¼ã‚³ãƒ¼ãƒ‰ç¢ºèª';
            }
        }

        async function resendConfirmationCode(email) {
            try {
                const response = await fetch(`${API_BASE_URL}/auth/resend-code`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: email
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showMessage('èªè¨¼ã‚³ãƒ¼ãƒ‰ã‚’å†é€ä¿¡ã—ã¾ã—ãŸ', 'success');
                } else {
                    showMessage(data.error, 'error');
                }
            } catch (error) {
                console.error('Resend error:', error);
                showMessage('å†é€ä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
            }
        }

        function handleEmergencyLogin(e) {
            e.preventDefault();
            const username = document.getElementById('emergencyUsername').value;
            const password = document.getElementById('emergencyPassword').value;
            const submitBtn = e.target.querySelector('button[type="submit"]');
            
            submitBtn.disabled = true;
            submitBtn.textContent = 'ãƒ­ã‚°ã‚¤ãƒ³ä¸­...';
            
            setTimeout(() => {
                if (username === 'sapporo-guide' && password === 'hokkaido2024') {
                    isLoggedIn = true;
                    sessionStorage.setItem('tourismAuth', 'true');
                    sessionStorage.setItem('sapporoUser', username);
                    // Set a dummy token for emergency login to work with API
                    sessionStorage.setItem('accessToken', 'emergency-login-token');
                    showMainApp();
                } else {
                    alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“');
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'ç·Šæ€¥ãƒ­ã‚°ã‚¤ãƒ³';
                }
            }, 1000);
        }
        
        // Handle OAuth callback
        function handleOAuthCallback() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const error = urlParams.get('error');
            
            
            if (error) {
                console.error('âŒ OAuth error:', error);
                alert('ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error);
                return;
            }
            
            if (code) {
                console.log('âœ… OAuth code received, exchanging for tokens...');
                // Exchange code for tokens with Cognito
                exchangeCodeForTokens(code)
                    .then(tokens => {
                        console.log('âœ… Token exchange successful:', {
                            has_access_token: !!tokens.access_token,
                            has_email: !!tokens.email,
                            has_user_id: !!tokens.user_id
                        });
                        
                        // Store tokens and user info
                        sessionStorage.setItem('tourismAuth', 'true');
                        sessionStorage.setItem('accessToken', tokens.access_token);
                        sessionStorage.setItem('sapporoUser', tokens.display_name || tokens.email || 'Google User');
                        sessionStorage.setItem('userInfo', JSON.stringify({
                            user_id: tokens.user_id,
                            email: tokens.email,
                            display_name: tokens.display_name
                        }));
                        
                        // Clean URL and show main app
                        window.history.replaceState({}, document.title, window.location.pathname);
                        isLoggedIn = true;
                        showMainApp();
                        updateHeaderUserInfo(); // Update header with correct user info
                        
                        // Create user record if new user
                        console.log('ğŸ”§ Proceeding to create user...');
                        createUserIfNeeded(tokens);
                    })
                    .catch(error => {
                        console.error('âŒ Token exchange error:', error);
                        alert('ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    });
            } else {
                console.log('â„¹ï¸ No OAuth code found in URL');
            }
        }
        
        async function exchangeCodeForTokens(code) {
            const tokenUrl = 'https://ai-tourism-auth.auth.ap-northeast-1.amazoncognito.com/oauth2/token';
            const redirectUri = window.location.origin + window.location.pathname;
            
            console.log('ğŸ”§ Exchanging code for tokens...', { tokenUrl, redirectUri, code: code.substring(0, 20) + '...' });
            
            const response = await fetch(tokenUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: new URLSearchParams({
                    grant_type: 'authorization_code',
                    client_id: '2tctru78c2epl4mbhrt8asd55e',
                    code: code,
                    redirect_uri: redirectUri
                })
            });
            
            console.log('ğŸ“‹ Token response status:', response.status);
            
            if (!response.ok) {
                const errorText = await response.text();
                console.error('âŒ Token exchange failed:', errorText);
                throw new Error('Token exchange failed: ' + errorText);
            }
            
            const tokens = await response.json();
            console.log('âœ… Tokens received:', Object.keys(tokens));
            
            // Get user info from Cognito OAuth userinfo endpoint
            console.log('ğŸ”§ Getting user info from Cognito OAuth userinfo endpoint...');
            const userInfoUrl = 'https://ai-tourism-auth.auth.ap-northeast-1.amazoncognito.com/oauth2/userInfo';
            const userResponse = await fetch(userInfoUrl, {
                headers: {
                    'Authorization': `Bearer ${tokens.access_token}`
                }
            });
            
            console.log('ğŸ“‹ User info response status:', userResponse.status);
            
            if (userResponse.ok) {
                const userInfo = await userResponse.json();
                console.log('âœ… User info received from Cognito:', {
                    email: userInfo.email,
                    name: userInfo.name,
                    sub: userInfo.sub,
                    username: userInfo.username
                });
                tokens.email = userInfo.email;
                tokens.display_name = userInfo.name || userInfo.given_name || userInfo.email;
                tokens.user_id = userInfo.username || userInfo.sub;
            } else {
                const errorText = await userResponse.text();
                console.warn('âš ï¸ User info fetch failed:', errorText);
                // Fallback to decoded token info if available
                try {
                    const payload = JSON.parse(atob(tokens.access_token.split('.')[1]));
                    console.log('ğŸ”§ Fallback: Using token payload:', payload);
                    tokens.email = payload.email || 'unknown@example.com';
                    tokens.display_name = payload.name || payload.given_name || 'Google User';
                    tokens.user_id = payload.sub || payload.username;
                } catch (e) {
                    console.warn('âš ï¸ Could not decode token payload:', e);
                }
            }
            
            return tokens;
        }
        
        async function createUserIfNeeded(tokens) {
            console.log('ğŸ”§ Creating user if needed...', {
                email: tokens.email,
                display_name: tokens.display_name,
                has_access_token: !!tokens.access_token,
                user_id: tokens.user_id
            });
            
            try {
                const response = await fetch(`${API_BASE_URL}/auth/create-user`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${tokens.access_token}`
                    },
                    body: JSON.stringify({
                        user_id: tokens.user_id,
                        email: tokens.email,
                        display_name: tokens.display_name,
                        auth_provider: 'google'
                    })
                });
                
                console.log('âœ… Create user API response status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.warn('âš ï¸ Create user API error:', errorText);
                } else {
                    const result = await response.json();
                    console.log('âœ… User created successfully:', result);
                }
            } catch (error) {
                console.error('âŒ User creation error:', error);
            }
        }
        
        function handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const loginBtn = document.getElementById('loginBtn');

            const currentLanguage = sessionStorage.getItem('selectedLanguage') || 'ja';
            const t = translations[currentLanguage];

            loginBtn.disabled = true;
            loginBtn.textContent = t.loginProcessing;

            setTimeout(() => {
                if (username === CREDENTIALS.username && password === CREDENTIALS.password) {
                    isLoggedIn = true;
                    sessionStorage.setItem('tourismAuth', 'true');
                    sessionStorage.setItem('sapporoUser', username);
                    showMainApp();
                } else {
                    const errorMessages = {
                        ja: 'âŒ ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ\n\næ­£ã—ã„IDãƒ»ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„\n\nID: sapporo-guide\nPASS: hokkaido2024',
                        ko: 'âŒ ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤\n\nì˜¬ë°”ë¥¸ IDãƒ»ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”\n\nID: sapporo-guide\nPASS: hokkaido2024',
                        zh: 'âŒ ç™»å½•å¤±è´¥\n\nè¯·è¾“å…¥æ­£ç¡®çš„IDãƒ»å¯†ç \n\nID: sapporo-guide\nPASS: hokkaido2024',
                        en: 'âŒ Login failed\n\nPlease enter correct ID and password\n\nID: sapporo-guide\nPASS: hokkaido2024'
                    };
                    alert(errorMessages[currentLanguage]);
                    loginBtn.disabled = false;
                    loginBtn.textContent = 'ğŸ” ' + t.loginButton;
                }
            }, 800);
        }

        function checkOldAuthStatus() {
            // å¤ã„èªè¨¼ã‚·ã‚¹ãƒ†ãƒ ç”¨ï¼ˆç¾åœ¨ã¯éæ¨å¥¨ï¼‰
            const authStatus = sessionStorage.getItem('sapporoAuth');
            const username = sessionStorage.getItem('sapporoUser');
            
            if (authStatus === 'true' && username) {
                isLoggedIn = true;
                showMainApp();
                updateHeaderUserInfo(); // Use the proper function that handles user info correctly
            }
        }

        function showMainApp() {
            loginSection.classList.add('hidden');
            mainApp.classList.add('active');
            userInfo.classList.add('active');
        }

        function logout() {
            isLoggedIn = false;
            sessionStorage.removeItem('tourismAuth');
            sessionStorage.removeItem('tourismUser');
            sessionStorage.removeItem('accessToken');
            sessionStorage.removeItem('userInfo');
            
            resetApp();
            
            mainApp.classList.remove('active');
            userInfo.classList.remove('active');
            loginSection.classList.remove('hidden');
            
            // Reset login form if it exists
            const loginForm = document.getElementById('loginForm');
            if (loginForm && typeof loginForm.reset === 'function') {
                loginForm.reset();
            }
            
            // Reset other forms that might exist
            const signupForm = document.getElementById('signupForm');
            if (signupForm && typeof signupForm.reset === 'function') {
                signupForm.reset();
            }
            
            showMessage('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ', 'info');
        }

        // File Handling
        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) processFile(file);
        }

        function handleDragOver(e) {
            e.preventDefault();
            uploadSection.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            uploadSection.classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            uploadSection.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) processFile(files[0]);
        }

        function processFile(file) {
            // Validate file
            if (!file.type.startsWith('image/')) {
                alert('âŒ ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„\n\nå¯¾å¿œå½¢å¼: JPG, PNG, GIF');
                return;
            }

            if (file.size > 10 * 1024 * 1024) {
                alert('âŒ ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã¯10MBä»¥ä¸‹ã«ã—ã¦ãã ã•ã„\n\nç¾åœ¨ã®ã‚µã‚¤ã‚º: ' + (file.size / (1024 * 1024)).toFixed(1) + 'MB');
                return;
            }

            // Resize image if needed
            resizeImage(file, 1200).then(resizedFile => {
                selectedImage = resizedFile;
                showPreview(resizedFile);
            }).catch(error => {
                console.error('Image resize error:', error);
                selectedImage = file;
                showPreview(file);
            });
        }

        function resizeImage(file, maxSize = 1200) {
            return new Promise((resolve, reject) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                img.onload = function() {
                    // Calculate new dimensions
                    let { width, height } = img;
                    
                    if (width <= maxSize && height <= maxSize) {
                        // No resize needed
                        resolve(file);
                        return;
                    }
                    
                    // Calculate resize ratio
                    const ratio = Math.min(maxSize / width, maxSize / height);
                    width *= ratio;
                    height *= ratio;
                    
                    // Set canvas size
                    canvas.width = width;
                    canvas.height = height;
                    
                    // Draw resized image
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // Convert to blob
                    canvas.toBlob((blob) => {
                        if (blob) {
                            // Create new File object
                            const resizedFile = new File([blob], file.name, {
                                type: file.type,
                                lastModified: Date.now()
                            });
                            
                            console.log(`Image resized: ${img.width}x${img.height} â†’ ${width}x${height}`);
                            console.log(`File size: ${(file.size/1024).toFixed(1)}KB â†’ ${(resizedFile.size/1024).toFixed(1)}KB`);
                            
                            resolve(resizedFile);
                        } else {
                            reject(new Error('Failed to resize image'));
                        }
                    }, file.type, 0.9);
                };
                
                img.onerror = () => reject(new Error('Failed to load image'));
                img.src = URL.createObjectURL(file);
            });
        }

        function showPreview(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('previewImage').src = e.target.result;
                document.getElementById('imageDetails').innerHTML = `
                    <div class="image-detail">ğŸ“ <strong>ãƒ•ã‚¡ã‚¤ãƒ«å:</strong> ${file.name}</div>
                    <div class="image-detail">ğŸ“ <strong>ã‚µã‚¤ã‚º:</strong> ${(file.size / 1024).toFixed(1)} KB</div>
                    <div class="image-detail">ğŸ–¼ï¸ <strong>å½¢å¼:</strong> ${file.type}</div>
                `;
                
                uploadSection.classList.add('hidden');
                previewSection.classList.remove('hidden');
                previewSection.classList.add('fade-in');
                
                // Scroll to preview
                previewSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
            };
            reader.readAsDataURL(file);
        }

        // Image Analysis with S3 Upload
        async function analyzeImage() {
            if (!selectedImage || !isLoggedIn) return;

            showLoading();

            try {
                const reader = new FileReader();
                reader.onload = async function(e) {
                    const base64Data = e.target.result.split(',')[1]; // Remove data:image/jpeg;base64, prefix
                    
                    try {
                        // Get selected language and analysis type
                        const selectedLanguage = document.querySelector('input[name="language"]:checked').value;
                        const selectedType = document.querySelector('input[name="analysisType"]:checked').value;
                        const currentUser = sessionStorage.getItem('sapporoUser') || 'sapporo-guide';
                        
                        // Upload image to S3 first
                        const uploadResponse = await fetch(`${API_BASE_URL}/upload-image`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                image: base64Data,
                                filename: selectedImage.name || 'image.jpg',
                                userId: currentUser,
                                analysisType: selectedType,
                                language: selectedLanguage
                            })
                        });

                        let imageUploadResult = null;
                        if (uploadResponse.ok) {
                            imageUploadResult = await uploadResponse.json();
                            console.log('Image uploaded to S3:', imageUploadResult);
                        } else {
                            console.warn('Image upload failed, proceeding with analysis');
                        }
                        
                        // Proceed with analysis regardless of upload success
                        const authToken = sessionStorage.getItem('accessToken');
                        const headers = {
                            'Content-Type': 'application/json'
                        };
                        
                        // Add authorization header if available
                        if (authToken) {
                            headers['Authorization'] = `Bearer ${authToken}`;
                        }
                        
                        const response = await fetch(`${API_BASE_URL}/analyze`, {
                            method: 'POST',
                            headers: headers,
                            body: JSON.stringify({
                                image: `data:image/jpeg;base64,${base64Data}`,
                                language: selectedLanguage,
                                type: selectedType,
                                imageId: imageUploadResult?.image_id || null,
                                s3Url: imageUploadResult?.s3_url || null
                            })
                        });

                        const responseText = await response.text();
                        
                        // Check for usage limit exceeded (403 status)
                        if (response.status === 403) {
                            try {
                                const errorData = JSON.parse(responseText);
                                if (errorData.upgrade_required) {
                                    // Show upgrade message and modal
                                    showMessage(errorData.message || 'Freeä¸Šé™ã«é”ã—ã¾ã—ãŸã€‚ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã‚’ãŠé¡˜ã„ã—ã¾ã™', 'error');
                                    showUpgradeModal();
                                    loadingSection.classList.add('hidden');
                                    return;
                                }
                            } catch (e) {
                                console.error('Error parsing 403 response:', e);
                            }
                        }
                        
                        showResults(response.ok, responseText, imageUploadResult);
                        
                    } catch (error) {
                        showResults(false, `ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`);
                    }
                };
                
                reader.readAsDataURL(selectedImage);
                
            } catch (error) {
                showResults(false, `ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`);
            }
        }

        function showLoading() {
            previewSection.classList.add('hidden');
            loadingSection.classList.remove('hidden');
            loadingSection.classList.add('fade-in');
            
            // Scroll to loading
            loadingSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        // URLè‡ªå‹•ãƒªãƒ³ã‚¯å¤‰æ›é–¢æ•°
        function convertUrlsToLinks(text) {
            // URLæ­£è¦è¡¨ç¾ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆhttp/httpså¯¾å¿œï¼‰
            const urlPattern = /(https?:\/\/[^\s<>"]{2,})/gi;
            
            return text.replace(urlPattern, function(url) {
                // æœ«å°¾ã®å¥èª­ç‚¹ã‚’é™¤å»
                let cleanUrl = url.replace(/[.,;!?ï¼‰ã€‘\]}]+$/, '');
                let punctuation = url.substring(cleanUrl.length);
                
                return `<a href="${cleanUrl}" target="_blank" rel="noopener noreferrer" class="analysis-link">${cleanUrl}</a>${punctuation}`;
            });
        }

        // ãƒ†ã‚­ã‚¹ãƒˆã‚’HTMLã«å¤‰æ›ï¼ˆæ”¹è¡Œã¨URLãƒªãƒ³ã‚¯åŒ–ï¼‰
        function formatAnalysisText(text) {
            console.log('ğŸ“ formatAnalysisText called with text:', text?.substring(0, 100) + '...');
            
            // marked.jsã¨DOMPurifyã®åˆ©ç”¨å¯èƒ½æ€§ã‚’ãƒã‚§ãƒƒã‚¯
            const isMarkedAvailable = typeof marked !== 'undefined';
            const isDOMPurifyAvailable = typeof DOMPurify !== 'undefined';
            
            console.log('ğŸ”§ Library availability:', { 
                marked: isMarkedAvailable, 
                DOMPurify: isDOMPurifyAvailable 
            });
            
            if (!isMarkedAvailable) {
                console.warn('âš ï¸ marked.js is not available, using fallback HTML formatting');
                return formatAsPlainHTML(text);
            }
            
            if (!isDOMPurifyAvailable) {
                console.warn('âš ï¸ DOMPurify is not available, security risk exists');
            }
            
            try {
                console.log('ğŸš€ Attempting to parse Markdown...');
                // Markdownã‚’ãƒ‘ãƒ¼ã‚¹ã—ã¦è¡¨ç¤º
                const parsedMarkdown = marked.parse(text);
                console.log('âœ… Markdown parsed successfully, length:', parsedMarkdown.length);
                
                if (isDOMPurifyAvailable) {
                    // DOMPurifyã§ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–ï¼ˆXSSå¯¾ç­–ï¼‰
                    const sanitizedHtml = DOMPurify.sanitize(parsedMarkdown, {
                        ALLOWED_TAGS: ['h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'p', 'br', 'strong', 'em', 'u', 'ul', 'ol', 'li', 'a', 'code', 'pre', 'blockquote', 'table', 'thead', 'tbody', 'tr', 'th', 'td', 'img', 'hr', 'div', 'span'],
                        ALLOWED_ATTR: ['href', 'target', 'rel', 'title', 'class', 'id', 'src', 'alt']
                    });
                    console.log('ğŸ›¡ï¸ HTML sanitized successfully');
                    return sanitizedHtml;
                } else {
                    console.log('âš ï¸ Using unsanitized HTML (DOMPurify not available)');
                    return parsedMarkdown;
                }
                
            } catch (error) {
                console.error('âŒ Markdown parsing error:', error);
                console.log('ğŸ”„ Falling back to plain HTML formatting');
                return formatAsPlainHTML(text);
            }
        }
        
        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°: ãƒ—ãƒ¬ãƒ¼ãƒ³HTMLãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        function formatAsPlainHTML(text) {
            // HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ï¼ˆXSSå¯¾ç­–ï¼‰
            const escapeHtml = (unsafe) => {
                return unsafe
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&#039;");
            };
            
            // ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã—ã¦ã‹ã‚‰æ”¹è¡Œã‚’BRã‚¿ã‚°ã«å¤‰æ›
            let escaped = escapeHtml(text);
            let withLineBreaks = escaped.replace(/\n/g, '<br>');
            
            // URLã‚’ãƒªãƒ³ã‚¯ã«å¤‰æ›
            return convertUrlsToLinks(withLineBreaks);
        }

        function showResults(success, responseText, uploadInfo = null) {
            loadingSection.classList.add('hidden');
            resultsSection.classList.remove('hidden');
            resultsSection.classList.add('fade-in');
            
            let content;
            if (success) {
                try {
                    const result = JSON.parse(responseText);
                    content = result.analysis || 'ãƒ‡ãƒ¼ã‚¿ã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸ';
                    
                    // Update user plan display with usage info from response
                    if (result.usage_info) {
                        console.log('Updating user plan display with usage info:', result.usage_info);
                        const userPlan = document.querySelector('.user-plan');
                        if (userPlan && result.usage_info.user_type === 'free') {
                            const remaining = result.usage_info.remaining || 0;
                            userPlan.textContent = `Free (æ®‹ã‚Š${remaining}å›)`;
                            
                            // Show upgrade button if remaining <= 2
                            const upgradeBtn = document.querySelector('.upgrade-btn');
                            if (upgradeBtn) {
                                upgradeBtn.style.display = remaining <= 2 ? 'inline-block' : 'none';
                            }
                        }
                    } else {
                        // Fallback: Update user plan display after successful analysis
                        updateUserPlanDisplay();
                    }
                } catch (e) {
                    content = responseText;
                }
                
                // Image is saved silently in background
            } else {
                content = `âŒ ${responseText}`;
            }
            
            // ãƒ†ã‚­ã‚¹ãƒˆã‚’æ•´å½¢ã—ã¦HTMLã¨ã—ã¦æŒ¿å…¥ï¼ˆURLã‚’è‡ªå‹•ãƒªãƒ³ã‚¯åŒ–ï¼‰
            document.getElementById('resultsContent').innerHTML = formatAnalysisText(content);
            
            // Scroll to results
            resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function newAnalysis() {
            resetApp();
            // Scroll to upload
            uploadSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        function resetApp() {
            selectedImage = null;
            uploadSection.classList.remove('hidden');
            previewSection.classList.add('hidden');
            loadingSection.classList.add('hidden');
            resultsSection.classList.add('hidden');
            document.getElementById('imageInput').value = '';
        }

        // Analysis type change handler
        const analysisTypeRadios = document.querySelectorAll('input[name="analysisType"]');
        if (analysisTypeRadios.length > 0) {
            analysisTypeRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    updateAnalysisUI(this.value);
                });
            });
        }

        function updateAnalysisUI(type) {
            const btnText = document.getElementById('analyzeBtnText');
            const recommendedText = document.getElementById('recommendedText');
            
            // ç¾åœ¨ã®è¨€èªã‚’å–å¾—
            const currentLang = document.getElementById('languageSelect').value;
            const t = translations[currentLang];
            
            if (type === 'menu') {
                btnText.textContent = 'ğŸ“‹ğŸœ ' + t.menuTranslation + t.startText;
                // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”¨ã®æ¨å¥¨ãƒ†ã‚­ã‚¹ãƒˆã«åˆ‡ã‚Šæ›¿ãˆ
                recommendedText.setAttribute('data-i18n', 'menuRecommended');
                recommendedText.textContent = t.menuRecommended;
            } else {
                btnText.textContent = 'ğŸ¤– ' + t.analyzeButton;
                // åº—èˆ—ç”¨ã®æ¨å¥¨ãƒ†ã‚­ã‚¹ãƒˆã«åˆ‡ã‚Šæ›¿ãˆ
                recommendedText.setAttribute('data-i18n', 'storeRecommended');
                recommendedText.textContent = t.storeRecommended;
            }
            
            // data-i18nå±æ€§ã‚’ä½¿ç”¨ã—ã¦UIã‚’æ›´æ–°
            updateUILanguage(currentLang);
        }


        // Auto-fill demo credentials on focus (only if elements exist)
        const usernameField = document.getElementById('username');
        const passwordField = document.getElementById('password');
        
        if (usernameField) {
            usernameField.addEventListener('focus', function() {
                if (!this.value) this.value = 'sapporo-guide';
            });
        }
        
        if (passwordField) {
            passwordField.addEventListener('focus', function() {
                if (!this.value) this.value = 'hokkaido2024';
            });
        }
    </script>

    <!-- Authentication Modal -->
    <div id="authModal" class="auth-modal">
        <div class="auth-content">
            <button class="auth-close" onclick="closeAuthModal()">&times;</button>
            
            <!-- Login Form -->
            <div id="loginForm" class="auth-form">
                <h2>ãƒ­ã‚°ã‚¤ãƒ³</h2>
                <form onsubmit="handleLogin(event)">
                    <input type="email" id="loginEmail" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹" required>
                    <input type="password" id="loginPassword" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" required>
                    <button type="submit" class="auth-btn">ãƒ­ã‚°ã‚¤ãƒ³</button>
                </form>
                <p>ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ãŠæŒã¡ã§ãªã„æ–¹ã¯ <a href="#" onclick="showSignupForm()">æ–°è¦ç™»éŒ²</a></p>
            </div>
            
            <!-- Signup Form -->
            <div id="signupForm" class="auth-form" style="display: none;">
                <h2>æ–°è¦ç™»éŒ²</h2>
                <form onsubmit="handleSignup(event)">
                    <input type="text" id="signupName" placeholder="ãŠåå‰" required>
                    <input type="email" id="signupEmail" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹" required>
                    <input type="password" id="signupPassword" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆ8æ–‡å­—ä»¥ä¸Šï¼‰" required minlength="8">
                    <button type="submit" class="auth-btn">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆ</button>
                </form>
                <p>ã™ã§ã«ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ãŠæŒã¡ã®æ–¹ã¯ <a href="#" onclick="showLoginForm()">ãƒ­ã‚°ã‚¤ãƒ³</a></p>
            </div>
            
            <!-- Email Confirmation Form -->
            <div id="confirmationForm" class="auth-form" style="display: none;">
                <h2>ãƒ¡ãƒ¼ãƒ«èªè¨¼</h2>
                <p>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã«é€ä¿¡ã•ã‚ŒãŸèªè¨¼ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
                <form onsubmit="handleConfirmation(event)">
                    <input type="text" id="confirmationCode" placeholder="èªè¨¼ã‚³ãƒ¼ãƒ‰" required>
                    <button type="submit" class="auth-btn">èªè¨¼ã™ã‚‹</button>
                </form>
                <p><a href="#" onclick="resendConfirmationCode()">èªè¨¼ã‚³ãƒ¼ãƒ‰ã‚’å†é€ä¿¡</a></p>
            </div>
        </div>
    </div>

    <!-- Premium Upgrade Modal -->
    <div id="upgradeModal" class="upgrade-modal">
        <div class="upgrade-content">
            <h2 class="upgrade-title">â­ ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ—ãƒ©ãƒ³ã«ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰</h2>
            <p style="color: #666; margin-bottom: 2rem;">ç„¡åˆ¶é™ã§AIè§£æã‚’ãŠæ¥½ã—ã¿ãã ã•ã„</p>
            
            <div class="plan-options">
                <div class="plan-card" onclick="selectPlan('7days')" id="plan7days">
                    <div class="plan-name">7æ—¥é–“ãƒ—ãƒ©ãƒ³</div>
                    <div class="plan-price">Â¥980</div>
                    <div class="plan-duration">1é€±é–“ç„¡åˆ¶é™</div>
                    <ul class="plan-features">
                        <li>AIè§£æç„¡åˆ¶é™</li>
                        <li>é«˜å„ªå…ˆåº¦å‡¦ç†</li>
                        <li>è©³ç´°åˆ†æãƒ¬ãƒãƒ¼ãƒˆ</li>
                    </ul>
                </div>
                
                <div class="plan-card selected" onclick="selectPlan('20days')" id="plan20days">
                    <div class="plan-name">20æ—¥é–“ãƒ—ãƒ©ãƒ³</div>
                    <div class="plan-price">Â¥1,980</div>
                    <div class="plan-duration">20æ—¥é–“ç„¡åˆ¶é™</div>
                    <ul class="plan-features">
                        <li>AIè§£æç„¡åˆ¶é™</li>
                        <li>é«˜å„ªå…ˆåº¦å‡¦ç†</li>
                        <li>è©³ç´°åˆ†æãƒ¬ãƒãƒ¼ãƒˆ</li>
                        <li>ãŠå¾—ï¼ç´„50%ã‚ªãƒ•</li>
                    </ul>
                </div>
            </div>
            
            <!-- Stripe Checkout æº–å‚™ä¸­è¡¨ç¤º (åˆæœŸã¯éè¡¨ç¤º) -->
            <div id="paymentSection" class="payment-section" style="display: none;">
                <h3 style="color: #333; margin-bottom: 1rem;">ğŸ’³ æ±ºæ¸ˆãƒšãƒ¼ã‚¸ã«ç§»å‹•ä¸­...</h3>
                <div style="text-align: center; padding: 2rem;">
                    <div class="spinner" style="display: inline-block; width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #ff9800; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                    <p style="margin-top: 1rem; color: #666;">å®‰å…¨ãªStripeæ±ºæ¸ˆãƒšãƒ¼ã‚¸ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã—ã¦ã„ã¾ã™...</p>
                </div>
                <div class="payment-security" style="text-align: center; margin-top: 1rem; color: #666; font-size: 0.9rem;">
                    ğŸ”’ SSLæš—å·åŒ–é€šä¿¡ãƒ»Stripeç¤¾ã«ã‚ˆã‚‹å®‰å…¨æ±ºæ¸ˆ
                </div>
            </div>
            
            <div id="planSelectionButtons" class="modal-buttons">
                <button class="modal-btn secondary" onclick="closeUpgradeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="modal-btn primary" onclick="proceedToPayment()">æ±ºæ¸ˆã«é€²ã‚€</button>
            </div>
        </div>
    </div>

    <script>
        let selectedPlan = '20days'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯20æ—¥é–“ãƒ—ãƒ©ãƒ³
        
        // èªè¨¼ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†
        let currentUser = null;
        let pendingSignupData = null; // ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—æ™‚ã®ä¸€æ™‚ãƒ‡ãƒ¼ã‚¿ä¿å­˜

        // èªè¨¼çŠ¶æ…‹å¤‰æ•°
        function getCurrentUserId() {
            if (currentUser) {
                return currentUser.user_id;
            }
            
            // æœªèªè¨¼ã®å ´åˆã¯èªè¨¼ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
            console.log('æœªèªè¨¼ãƒ¦ãƒ¼ã‚¶ãƒ¼: ãƒ­ã‚°ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º');
            showAuthModal();
            return null;
        }

        function isUserAuthenticated() {
            return currentUser !== null;
        }

        function getAuthToken() {
            return localStorage.getItem('accessToken');
        }

        // èªè¨¼é–¢é€£é–¢æ•°
        function showAuthModal() {
            document.getElementById('authModal').classList.add('show');
            showLoginForm();
        }

        function closeAuthModal() {
            document.getElementById('authModal').classList.remove('show');
        }

        function showLoginForm() {
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('signupForm').style.display = 'none';
            document.getElementById('confirmationForm').style.display = 'none';
        }

        function showSignupForm() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('signupForm').style.display = 'block';
            document.getElementById('confirmationForm').style.display = 'none';
        }

        function showConfirmationForm() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('signupForm').style.display = 'none';
            document.getElementById('confirmationForm').style.display = 'block';
        }

        // ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†
        async function handleLogin(event) {
            event.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            try {
                const response = await fetch('https://f4n095fm2j.execute-api.ap-northeast-1.amazonaws.com/dev/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const result = await response.json();

                if (response.ok) {
                    // èªè¨¼æˆåŠŸ
                    localStorage.setItem('accessToken', result.tokens.AccessToken);
                    localStorage.setItem('refreshToken', result.tokens.RefreshToken);
                    currentUser = result.user_info;
                    
                    closeAuthModal();
                    showMessage('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸ', 'success');
                    
                    // ãƒ­ã‚°ã‚¤ãƒ³å¾Œã«æ±ºæ¸ˆã«æˆ»ã‚‹å ´åˆ
                    if (selectedPlan) {
                        showUpgradeModal(); // ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’å†è¡¨ç¤º
                        setTimeout(() => {
                            proceedToPayment();
                        }, 1500);
                    }
                } else {
                    showMessage(`ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼: ${result.error}`, 'error');
                }
            } catch (error) {
                console.error('Login error:', error);
                showMessage('ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }

        // ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—å‡¦ç†
        async function handleSignup(event) {
            event.preventDefault();
            const name = document.getElementById('signupName').value;
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;

            pendingSignupData = { name, email, password };

            try {
                const response = await fetch('https://f4n095fm2j.execute-api.ap-northeast-1.amazonaws.com/dev/auth/signup', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        email, 
                        password, 
                        display_name: name 
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    showMessage('èªè¨¼ã‚³ãƒ¼ãƒ‰ã‚’ãƒ¡ãƒ¼ãƒ«ã«é€ä¿¡ã—ã¾ã—ãŸ', 'success');
                    showConfirmationForm();
                } else {
                    showMessage(`ç™»éŒ²ã‚¨ãƒ©ãƒ¼: ${result.error}`, 'error');
                }
            } catch (error) {
                console.error('Signup error:', error);
                showMessage('ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }

        // èªè¨¼ã‚³ãƒ¼ãƒ‰ç¢ºèªå‡¦ç†
        async function handleConfirmation(event) {
            event.preventDefault();
            const confirmationCode = document.getElementById('confirmationCode').value;

            if (!pendingSignupData) {
                showMessage('ç™»éŒ²æƒ…å ±ãŒä¸æ­£ã§ã™', 'error');
                return;
            }

            try {
                const response = await fetch('https://f4n095fm2j.execute-api.ap-northeast-1.amazonaws.com/dev/auth/confirm-signup', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: pendingSignupData.email,
                        password: pendingSignupData.password,
                        confirmation_code: confirmationCode
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    // èªè¨¼æˆåŠŸã€è‡ªå‹•ãƒ­ã‚°ã‚¤ãƒ³
                    localStorage.setItem('accessToken', result.tokens.AccessToken);
                    localStorage.setItem('refreshToken', result.tokens.RefreshToken);
                    currentUser = result.user_info;
                    
                    closeAuthModal();
                    showMessage('ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒä½œæˆã•ã‚Œã¾ã—ãŸ', 'success');
                    pendingSignupData = null;
                    
                    // ç™»éŒ²å¾Œã«æ±ºæ¸ˆã«æˆ»ã‚‹å ´åˆ
                    if (selectedPlan) {
                        showUpgradeModal(); // ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’å†è¡¨ç¤º
                        setTimeout(() => {
                            proceedToPayment();
                        }, 1000);
                    }
                } else {
                    showMessage(`èªè¨¼ã‚¨ãƒ©ãƒ¼: ${result.error}`, 'error');
                }
            } catch (error) {
                console.error('Confirmation error:', error);
                showMessage('èªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }

        // èªè¨¼ã‚³ãƒ¼ãƒ‰å†é€ä¿¡
        async function resendConfirmationCode() {
            if (!pendingSignupData) {
                showMessage('ç™»éŒ²æƒ…å ±ãŒä¸æ­£ã§ã™', 'error');
                return;
            }

            try {
                const response = await fetch('https://f4n095fm2j.execute-api.ap-northeast-1.amazonaws.com/dev/auth/resend-code', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: pendingSignupData.email })
                });

                const result = await response.json();

                if (response.ok) {
                    showMessage('èªè¨¼ã‚³ãƒ¼ãƒ‰ã‚’å†é€ä¿¡ã—ã¾ã—ãŸ', 'success');
                } else {
                    showMessage(`å†é€ä¿¡ã‚¨ãƒ©ãƒ¼: ${result.error}`, 'error');
                }
            } catch (error) {
                console.error('Resend error:', error);
                showMessage('å†é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®èªè¨¼çŠ¶æ…‹ç¢ºèª
        async function checkAuthStatus() {
            const token = getAuthToken();
            if (token && !currentUser) { // currentUserãŒnullã®å ´åˆã®ã¿å®Ÿè¡Œ
                try {
                    const response = await fetch('https://f4n095fm2j.execute-api.ap-northeast-1.amazonaws.com/dev/auth/user-info', {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (response.ok) {
                        const userInfo = await response.json();
                        currentUser = userInfo;
                        console.log('âœ… èªè¨¼çŠ¶æ…‹å¾©å…ƒ:', currentUser.email);
                    } else {
                        console.log('âš ï¸ Token invalid, clearing auth state');
                        localStorage.removeItem('accessToken');
                        localStorage.removeItem('refreshToken');
                        currentUser = null;
                    }
                } catch (error) {
                    console.error('Auth check error:', error);
                    // ã‚¨ãƒ©ãƒ¼æ™‚ã§ã‚‚æ—¢å­˜ã®currentUserã¯ä¿æŒ
                    if (!currentUser) {
                        localStorage.removeItem('accessToken');
                        localStorage.removeItem('refreshToken');
                    }
                }
            } else if (currentUser) {
                console.log('âœ… Authentication already verified:', currentUser.email);
            }
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«èªè¨¼çŠ¶æ…‹ç¢ºèª
        window.addEventListener('load', checkAuthStatus);
        
        // Stripeè¨­å®š
        const stripe = Stripe('pk_test_51RvuaERVpc2gZJezUtU3m18rgEASCWugNUe9KJBxqCSmDHPzfYet6Z1yTpvF5VccUscOVm4AX4l5AwncEAELAYfX002TJVRaa6');

        function showUpgradeModal() {
            
            const currentLanguage = sessionStorage.getItem('selectedLanguage') || 'ja';
            const t = translations[currentLanguage];
            
            // å‹•çš„ã«ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ç”Ÿæˆ
            const upgradeModal = document.getElementById('upgradeModal');
            const upgradeContent = upgradeModal.querySelector('.upgrade-content');
            
            upgradeContent.innerHTML = `
                <h2 class="upgrade-title">${t.upgradeTitle}</h2>
                <p style="color: #666; margin-bottom: 2rem;">${t.upgradeDescription}</p>
                
                <div class="plan-options">
                    <div class="plan-card" onclick="selectPlan('7days')" id="plan7days">
                        <div class="plan-name">${t.plan7days}</div>
                        <div class="plan-price">${t.price980}</div>
                        <div class="plan-duration">${t.duration7days}</div>
                        <ul class="plan-features">
                            <li>${t.featureUnlimited}</li>
                            <li>${t.featurePriority}</li>
                            <li>${t.featureReport}</li>
                        </ul>
                    </div>
                    
                    <div class="plan-card selected" onclick="selectPlan('20days')" id="plan20days">
                        <div class="plan-name">${t.plan20days}</div>
                        <div class="plan-price">${t.price1980}</div>
                        <div class="plan-duration">${t.duration20days}</div>
                        <div class="plan-popular">${t.popularPlan}</div>
                        <ul class="plan-features">
                            <li>${t.featureUnlimited}</li>
                            <li>${t.featurePriority}</li>
                            <li>${t.featureReport}</li>
                        </ul>
                    </div>
                </div>
                
                <!-- Stripe Checkout æº–å‚™ä¸­è¡¨ç¤º (åˆæœŸã¯éè¡¨ç¤º) -->
                <div id="paymentSection" class="payment-section" style="display: none;">
                    <h3 style="color: #333; margin-bottom: 1rem;">${t.paymentPreparation}</h3>
                    <div style="text-align: center; padding: 2rem;">
                        <div class="spinner" style="display: inline-block; width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #ff9800; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                        <p style="margin-top: 1rem; color: #666;">${t.stripeRedirect}</p>
                    </div>
                    <div class="payment-security" style="text-align: center; margin-top: 1rem; color: #666; font-size: 0.9rem;">
                        ${t.paymentSecurity}
                    </div>
                </div>
                
                <div id="planSelectionButtons" class="modal-buttons">
                    <button class="modal-btn secondary" onclick="closeUpgradeModal()">${t.cancelPayment}</button>
                    <button class="modal-btn primary" onclick="proceedToPayment()">${t.proceedPayment}</button>
                </div>
            `;
            
            upgradeModal.classList.add('show');
        }

        function closeUpgradeModal() {
            document.getElementById('upgradeModal').classList.remove('show');
            resetPaymentForm();
        }

        function selectPlan(planType) {
            selectedPlan = planType;
            
            // Remove selection from all plans
            document.querySelectorAll('.plan-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // Add selection to clicked plan
            document.getElementById('plan' + planType).classList.add('selected');
        }

        async function proceedToPayment() {
            try {
                console.log('ğŸ’³ Starting Stripe payment process for plan:', selectedPlan);
                
                // èªè¨¼ãƒã‚§ãƒƒã‚¯
                if (!isUserAuthenticated()) {
                    console.log('æœªèªè¨¼ãƒ¦ãƒ¼ã‚¶ãƒ¼: èªè¨¼ãŒå¿…è¦ã§ã™');
                    showMessage('æ±ºæ¸ˆã«ã¯ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™', 'info');
                    
                    // ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã¦èªè¨¼ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
                    closeUpgradeModal();
                    showAuthModal();
                    return;
                }
                
                const userId = getCurrentUserId();
                
                if (!userId) {
                    console.error('âŒ User ID is null despite authentication');
                    showMessage('ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                    return;
                }
                
                console.log('âœ… Authentication verified, proceeding with payment...');
                
                // ãƒ—ãƒ©ãƒ³é¸æŠç”»é¢ã‚’éè¡¨ç¤ºã«ã—ã¦æ±ºæ¸ˆæº–å‚™ç”»é¢ã‚’è¡¨ç¤º
                document.getElementById('planSelectionButtons').style.display = 'none';
                document.getElementById('paymentSection').style.display = 'block';
                
                showMessage('æ±ºæ¸ˆãƒšãƒ¼ã‚¸ã‚’æº–å‚™ä¸­...', 'info');
                
                // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã«Checkout Sessionä½œæˆãƒªã‚¯ã‚¨ã‚¹ãƒˆ
                const response = await fetch('https://f4n095fm2j.execute-api.ap-northeast-1.amazonaws.com/dev/payment/create-checkout', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        planType: selectedPlan,
                        userId: userId
                    })
                });
                
                const result = await response.json();
                
                if (response.ok && result.checkout_url) {
                    console.log('âœ… Checkout session created:', result.session_id);
                    console.log('ğŸš€ Redirecting to Stripe checkout:', result.checkout_url);
                    
                    // Stripe Checkoutãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
                    showMessage('æ±ºæ¸ˆãƒšãƒ¼ã‚¸ã«ç§»å‹•ã—ã¦ã„ã¾ã™...', 'info');
                    
                    // ãƒ‡ãƒãƒƒã‚°ï¼šãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå‰ã«2ç§’å¾…æ©Ÿ
                    setTimeout(() => {
                        console.log('ğŸ”— Executing redirect...');
                        window.location.href = result.checkout_url;
                    }, 2000);
                } else {
                    console.error('âŒ Payment API error:', {
                        status: response.status,
                        result: result
                    });
                    throw new Error(result.error || 'æ±ºæ¸ˆã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
                
            } catch (error) {
                console.error('Stripe checkout error:', error);
                showMessage('æ±ºæ¸ˆå‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message, 'error');
                resetPaymentForm();
            }
        }
        
        function resetPaymentForm() {
            // æ±ºæ¸ˆãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('paymentSection').style.display = 'none';
            document.getElementById('planSelectionButtons').style.display = 'block';
        }

        // æ±ºæ¸ˆå®Œäº†å‡¦ç†ï¼ˆStripe Checkoutã‹ã‚‰æˆ»ã£ã¦ããŸæ™‚ï¼‰
        function handlePaymentResult() {
            const urlParams = new URLSearchParams(window.location.search);
            const paymentStatus = urlParams.get('payment');
            const sessionId = urlParams.get('session_id');
            
            if (paymentStatus === 'success' && sessionId) {
                console.log('âœ… Payment completed:', sessionId);
                showMessage('ğŸ‰ æ±ºæ¸ˆãŒå®Œäº†ã—ã¾ã—ãŸï¼ãƒ—ãƒ¬ãƒŸã‚¢ãƒ æ©Ÿèƒ½ã‚’ãŠæ¥½ã—ã¿ãã ã•ã„', 'success');
                
                // æˆ»ã‚‹ãƒœã‚¿ãƒ³å¯¾ç­–: å±¥æ­´ã‚’CloudFrontãƒ«ãƒ¼ãƒˆã«è¨­å®š
                if (window.location.hostname === 'd22ztxm5q1c726.cloudfront.net') {
                    // 1. ç¾åœ¨ã®URLã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
                    window.history.replaceState({}, document.title, window.location.pathname);
                    
                    // 2. æˆ»ã‚Šå…ˆã¨ã—ã¦CloudFrontãƒ«ãƒ¼ãƒˆã‚’å±¥æ­´ã‚¹ã‚¿ãƒƒã‚¯ã«è¨­å®š
                    window.history.pushState(
                        { from: 'payment_success' }, 
                        'Tourism Analyzer - Home', 
                        'https://d22ztxm5q1c726.cloudfront.net/'
                    );
                    
                    // 3. ãƒ¡ã‚¤ãƒ³ç”»é¢ã«æˆ»ã‚‹ï¼ˆæˆ»ã‚‹ãƒœã‚¿ãƒ³ã§CloudFrontãƒ«ãƒ¼ãƒˆã«ç§»å‹•å¯èƒ½ï¼‰
                    window.history.back();
                    
                    console.log('ğŸ“ æ±ºæ¸ˆå®Œäº†: æˆ»ã‚‹ãƒœã‚¿ãƒ³ã§CloudFrontãƒ«ãƒ¼ãƒˆã«ç§»å‹•ã—ã¾ã™');
                } else {
                    // ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç’°å¢ƒç­‰ã®å ´åˆ
                    window.history.replaceState({}, document.title, window.location.pathname);
                }
                
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ©ãƒ³è¡¨ç¤ºã‚’æ›´æ–°
                setTimeout(() => {
                    updateUserPlanDisplay();
                }, 1000);
                
            } else if (paymentStatus === 'cancel') {
                console.log('âŒ Payment cancelled');
                showMessage('æ±ºæ¸ˆãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ', 'info');
                
                // æˆ»ã‚‹ãƒœã‚¿ãƒ³å¯¾ç­–: å±¥æ­´ã‚’CloudFrontãƒ«ãƒ¼ãƒˆã«è¨­å®š
                if (window.location.hostname === 'd22ztxm5q1c726.cloudfront.net') {
                    // 1. ç¾åœ¨ã®URLã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
                    window.history.replaceState({}, document.title, window.location.pathname);
                    
                    // 2. æˆ»ã‚Šå…ˆã¨ã—ã¦CloudFrontãƒ«ãƒ¼ãƒˆã‚’å±¥æ­´ã‚¹ã‚¿ãƒƒã‚¯ã«è¨­å®š
                    window.history.pushState(
                        { from: 'payment_cancel' }, 
                        'Tourism Analyzer - Home', 
                        'https://d22ztxm5q1c726.cloudfront.net/'
                    );
                    
                    // 3. ãƒ¡ã‚¤ãƒ³ç”»é¢ã«æˆ»ã‚‹ï¼ˆæˆ»ã‚‹ãƒœã‚¿ãƒ³ã§CloudFrontãƒ«ãƒ¼ãƒˆã«ç§»å‹•å¯èƒ½ï¼‰
                    window.history.back();
                    
                    console.log('ğŸ“ æ±ºæ¸ˆã‚­ãƒ£ãƒ³ã‚»ãƒ«: æˆ»ã‚‹ãƒœã‚¿ãƒ³ã§CloudFrontãƒ«ãƒ¼ãƒˆã«ç§»å‹•ã—ã¾ã™');
                } else {
                    // ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç’°å¢ƒç­‰ã®å ´åˆ
                    window.history.replaceState({}, document.title, window.location.pathname);
                }
            }
        }

        // Update user plan display based on user info
        async function updateUserPlanDisplay() {
            console.log('ğŸ”„ updateUserPlanDisplay called');
            
            // Debug session storage contents
            console.log('ğŸ’¾ SessionStorage contents:');
            console.log('  - userInfo:', sessionStorage.getItem('userInfo'));
            console.log('  - accessToken:', sessionStorage.getItem('accessToken'));
            console.log('  - sapporoAuth:', sessionStorage.getItem('sapporoAuth'));
            console.log('  - sapporoUser:', sessionStorage.getItem('sapporoUser'));
            
            const userInfo = sessionStorage.getItem('userInfo');
            if (!userInfo) {
                console.log('âŒ No userInfo in sessionStorage');
                return;
            }
            
            const user = JSON.parse(userInfo);
            console.log('ğŸ‘¤ Current user from sessionStorage:', user);
            const userPlanElement = document.getElementById('userPlan');
            const upgradeBtn = document.getElementById('upgradeBtn');
            
            try {
                // Get current usage info from backend
                const authToken = sessionStorage.getItem('accessToken');
                console.log('ğŸ”‘ Auth token details:');
                console.log('  - Present:', authToken ? 'Yes' : 'No');
                console.log('  - Type:', typeof authToken);
                console.log('  - Length:', authToken ? authToken.length : 0);
                console.log('  - First 50 chars:', authToken ? authToken.substring(0, 50) + '...' : 'N/A');
                
                const response = await fetch(`${API_BASE_URL}/auth/user-info`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                console.log('ğŸ“¡ API response:', response.status, response.statusText);
                
                if (response.ok) {
                    const userDetails = await response.json();
                    console.log('ğŸ“Š Fresh user data from API:', userDetails);
                    
                    const userType = userDetails.user_type || 'free';
                    const monthlyCount = userDetails.monthly_analysis_count || 0;
                    
                    console.log('ğŸ“ˆ User type:', userType, 'Monthly count:', monthlyCount);
                    
                    if (userType === 'free') {
                        const remaining = 5 - monthlyCount;
                        console.log('ğŸ†“ Free plan - Remaining:', remaining);
                        userPlanElement.textContent = `Free (æ®‹ã‚Š${remaining}å›)`;
                        userPlanElement.className = 'user-plan';
                        upgradeBtn.style.display = remaining <= 2 ? 'block' : 'none'; // æ®‹ã‚Š2å›ä»¥ä¸‹ã§è¡¨ç¤º
                    } else {
                        console.log('ğŸ’ Premium plan detected');
                        userPlanElement.textContent = `Premium (ç„¡åˆ¶é™)`;
                        userPlanElement.className = 'user-plan premium';
                        upgradeBtn.style.display = 'none';
                    }
                    
                    // Update sessionStorage with fresh data
                    sessionStorage.setItem('userInfo', JSON.stringify(userDetails));
                    console.log('ğŸ’¾ Updated sessionStorage with fresh user data');
                } else {
                    console.log('âŒ API Error Details:');
                    console.log('  - Status:', response.status);
                    console.log('  - Status Text:', response.statusText);
                    
                    if (response.status === 401) {
                        console.log('âš ï¸ Authentication failed, using default free plan display');
                        // Display default free plan info when auth fails
                        userPlanElement.textContent = 'Free (æ®‹ã‚Š5å›)';
                        userPlanElement.className = 'user-plan';
                        upgradeBtn.style.display = 'none';
                        
                        // Don't show error to user for 401, just use defaults
                        return;
                    } else if (response.status === 500) {
                        console.log('âš ï¸ Server error, using fallback display');
                        // Server error: use sessionStorage data if available
                        const userType = user.user_type || 'free';
                        const monthlyCount = user.monthly_analysis_count || 0;
                        
                        if (userType === 'free') {
                            const remaining = Math.max(0, 5 - monthlyCount);
                            userPlanElement.textContent = `Free (æ®‹ã‚Š${remaining}å›)`;
                            userPlanElement.className = 'user-plan';
                            upgradeBtn.style.display = remaining <= 2 ? 'block' : 'none';
                        } else {
                            userPlanElement.textContent = `Premium (ç„¡åˆ¶é™)`;
                            userPlanElement.className = 'user-plan premium';
                            upgradeBtn.style.display = 'none';
                        }
                        return;
                    }
                    
                    const errorText = await response.text();
                    console.log('  - Response Body:', errorText);
                }
            } catch (error) {
                console.error('âŒ Network error:', error);
            }
        }

        // Call updateUserPlanDisplay when user logs in
        function updateHeaderUserInfo() {
            const userInfo = sessionStorage.getItem('userInfo');
            const currentUserElement = document.getElementById('currentUser');
            const userInfoElement = document.getElementById('userInfo');
            
            if (userInfo) {
                const user = JSON.parse(userInfo);
                currentUserElement.textContent = user.display_name || user.email || 'User';
                userInfoElement.classList.add('active');
                
                // Update plan display
                updateUserPlanDisplay();
            } else {
                userInfoElement.classList.remove('active');
            }
        }

        // Close modal when clicking outside
        const upgradeModal = document.getElementById('upgradeModal');
        if (upgradeModal) {
            upgradeModal.addEventListener('click', function(e) {
                if (e.target === this) {
                    closeUpgradeModal();
                }
            });
        }
    </script>
</body>
</html>